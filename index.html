<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#005EB8">
<meta name="description" content="Major Incident Triage Tool">
<title>Major Incident Triage</title>
<!-- QR Library (Cached by Service Worker for offline use) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
    :root {
        --nhs-blue: #005EB8;
        --nhs-dark-blue: #003087;
        --nhs-green: #007F3B;
        --nhs-red: #DA291C;
        --nhs-yellow: #FAE100;
        --nhs-grey: #4C6272;
        --nhs-pale-grey: #E8EDEE;
        --white: #FFFFFF;
        --black: #212b32;
        --text-color: #212b32;
        --bg-color: #E8EDEE;
        --card-bg: #FFFFFF;
        --toast-bg: #333;
    }

    body.night-mode {
        --nhs-blue: #005EB8;
        --nhs-dark-blue: #000000;
        --nhs-pale-grey: #121212;
        --white: #000000;
        --black: #FFFFFF;
        --text-color: #f0f0f0;
        --bg-color: #000000;
        --card-bg: #1e1e1e;
        --toast-bg: #555;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        -webkit-font-smoothing: antialiased;
        overscroll-behavior-y: none;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        min-height: 100vh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        background-color: var(--card-bg);
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        transition: background-color 0.3s, color 0.3s;
    }

    header {
        background-color: var(--nhs-blue);
        color: white;
        padding: 0.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        gap: 10px;
    }

    h1 { margin: 0; font-size: 1.1rem; font-weight: bold; white-space: nowrap; }
    
    .status-bar {
        background-color: var(--nhs-dark-blue);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        flex-shrink: 0;
        white-space: nowrap;
        overflow-x: auto;
    }

    .status-item { margin-right: 15px; display: inline-flex; align-items: center; gap: 5px; }
    .gps-status { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.2); }
    .gps-active { color: #ccffcc; border: 1px solid #ccffcc; }
    .gps-inactive { color: #ffcccc; border: 1px solid #ffcccc; }

    .dashboard {
        display: flex;
        width: 100%;
        background: var(--card-bg);
        border-bottom: 1px solid #ccc;
        transition: all 0.3s ease;
        flex-shrink: 0;
        flex-wrap: wrap;
    }

    .dashboard:not(.expanded) { min-height: 40px; }
    .dashboard:not(.expanded) .dash-card {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 5px;
        border-radius: 0;
        font-size: 0.8rem;
        box-shadow: none;
    }
    .dashboard:not(.expanded) .dash-label { display: inline; }
    .dashboard:not(.expanded) .dash-num { display: inline; font-weight: bold; }

    .dashboard.expanded {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 10px;
        height: auto;
        border-bottom: 2px solid #ccc;
    }
    .dashboard.expanded .dash-card {
        padding: 10px 5px;
        text-align: center;
        border-radius: 6px;
        color: black;
        font-weight: bold;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: block;
    }
    .dashboard.expanded .dash-num { font-size: 1.4rem; display: block; }
    .dashboard.expanded .dash-label { font-size: 0.75rem; display: block; }

    .dash-p1 { background: var(--nhs-red); color: white; }
    .dash-p2 { background: var(--nhs-yellow); color: black; }
    .dash-p3 { background: var(--nhs-green); color: white; }
    .dash-dead { background: #333; color: white; }
    .dash-evac { background: var(--nhs-blue); color: white; grid-column: span 4; }

    main {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch;
    }

    .btn {
        display: block;
        width: 100%;
        padding: 1rem;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        font-weight: bold;
        text-align: center;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        color: white;
        touch-action: manipulation;
    }
    .btn:active { opacity: 0.8; transform: scale(0.99); }
    .btn-primary { background-color: var(--nhs-blue); }
    .btn-yes { background-color: var(--nhs-green); font-size: 1.5rem; height: 80px; }
    .btn-no { background-color: var(--nhs-red); font-size: 1.5rem; height: 80px; }
    .btn-secondary { background-color: var(--nhs-grey); }
    .btn-danger { background-color: var(--nhs-red); }
    .btn-evac { background-color: var(--nhs-dark-blue); border: 2px solid var(--nhs-blue); }

    .header-controls { display: flex; gap: 8px; }
    .icon-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.4);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        font-weight: bold;
    }

    #blackout-curtain {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: black;
        z-index: 9999;
        display: none;
        color: #333;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        user-select: none;
    }
    #blackout-curtain.active { display: flex; }

    .mode-badge {
        display: inline-block;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(0,0,0,0.3);
        margin-left: 5px;
        vertical-align: middle;
    }

    .input-group { margin-bottom: 1rem; position: relative; }
    .input-group label { display: block; font-weight: bold; margin-bottom: 0.4rem; color: var(--nhs-blue); }
    body.night-mode .input-group label { color: var(--nhs-yellow); }
    .input-group input, .input-group textarea, .input-group select {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px; 
        font-family: inherit;
        background: var(--card-bg);
        color: var(--text-color);
        -webkit-appearance: none;
    }

    .voice-btn {
        position: absolute;
        right: 10px;
        bottom: 10px;
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        opacity: 0.7;
    }

    .screen { display: none; height: 100%; flex-direction: column; }
    .screen.active { display: flex; }

    .clinical-note {
        font-size: 1rem;
        color: #333;
        background: #fff9e6;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        border: 1px solid #e0c880;
    }
    body.night-mode .clinical-note { background: #332b00; color: #fff; border-color: #665500; }

    .triage-tag {
        font-size: 4rem;
        font-weight: bold;
        text-align: center;
        padding: 2rem;
        margin: 1rem 0;
        border-radius: 12px;
        border: 4px solid #000;
        position: relative;
        background: var(--card-bg);
        color: var(--text-color);
    }
    body.night-mode .triage-tag { border-color: #fff; }

    .hr-badge {
        position: absolute; top: -12px; right: -10px;
        background: var(--nhs-red); color: white;
        font-size: 0.9rem; padding: 6px 12px;
        border-radius: 20px; border: 2px solid white;
        font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .p1 { background-color: var(--nhs-red) !important; color: white !important; }
    .p2 { background-color: var(--nhs-yellow) !important; color: black !important; }
    .p3 { background-color: var(--nhs-green) !important; color: white !important; }
    .dead { background-color: #fff !important; color: black !important; border-color: black !important; }

    .int-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 1rem; }
    .int-btn {
        background: var(--card-bg); border: 2px solid var(--nhs-blue); color: var(--nhs-blue);
        padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; text-align: center; font-size: 0.9rem;
    }
    .int-btn.active { background: var(--nhs-green); border-color: var(--nhs-green); color: white; }
    .int-time { display: block; font-size: 0.75rem; font-weight: normal; margin-top: 4px; }

    .log-container { overflow-x: auto; margin-bottom: 1rem; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { border: 1px solid #666; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #ddd; color: black; font-weight: bold; }
    body.night-mode th { background-color: #333; color: white; }
    
    tr.clickable-row { cursor: pointer; }
    tr.clickable-row:hover { background-color: rgba(0,0,0,0.05); }
    
    /* Tourniquet Critical Alert (>2 hours) */
    tr.critical-alert td { 
        background-color: #ffcccc !important; 
        color: #cc0000 !important; 
        font-weight: bold; 
        animation: pulse 2s infinite; 
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    #details-container { border-top: 1px solid #ccc; margin-top: 1rem; padding-top: 1rem; display: none; }
    #details-container.show { display: block; }
    
    /* Body Map Modal */
    #body-map-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 2000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
    }
    #body-map-modal svg { max-height: 70vh; max-width: 90vw; background: white; border-radius: 10px; }
    
    /* QR Modal */
    #qr-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 2000; display: none;
        flex-direction: column; align-items: center; justify-content: center; color: white;
    }
    #qrcode { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }

    #toast {
        visibility: hidden; min-width: 250px; background-color: var(--toast-bg); color: #fff;
        text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 3000;
        left: 50%; top: 30px; transform: translateX(-50%); font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0; transition: opacity 0.3s, top 0.3s;
    }
    #toast.show { visibility: visible; opacity: 1; top: 50px; }

    .editable-id { border-bottom: 1px dashed var(--nhs-blue); cursor: text; }

    @media print {
        header, .btn, .status-bar, .header-controls, #toast, #global-dashboard, .int-grid, #body-map-modal, #qr-modal, .voice-btn { display: none !important; }
        .screen { display: none !important; }
        #log-screen { display: block !important; }
        .log-container { overflow: visible; }
        body, .container { background: white; color: black; box-shadow: none; width: 100%; max-width: 100%; min-height: auto; }
        table { font-size: 10pt; width: 100%; border: 1px solid black; }
        th, td { border: 1px solid black; }
    }
</style>
</head>
<body>

<div id="toast">Notification</div>
<div id="blackout-curtain" onclick="toggleBlackout()"></div>

<!-- Body Map Modal -->
<div id="body-map-modal">
    <h3 style="color:white;">Tap Injury Location</h3>
    <svg id="bodymap" viewBox="0 0 200 400" width="300" height="500" onclick="handleBodyMapClick(event)">
        <path d="M100,20 C120,20 130,40 130,60 C130,70 120,80 100,80 C80,80 70,70 70,60 C70,40 80,20 100,20 Z" fill="#ddd" stroke="#333" stroke-width="2"/> <!-- Head -->
        <path d="M70,80 L40,100 L40,200 L60,200 L70,150 L70,250 L90,400 L110,400 L130,250 L130,150 L140,200 L160,200 L160,100 L130,80 Z" fill="#ddd" stroke="#333" stroke-width="2"/> <!-- Body/Limbs -->
    </svg>
    <button class="btn btn-secondary" style="width: auto; margin-top: 20px;" onclick="closeBodyMap()">Done</button>
</div>

<!-- QR Modal -->
<div id="qr-modal">
    <h3>Patient Passport</h3>
    <div id="qrcode"></div>
    <p>Scan to transfer data</p>
    <button class="btn btn-secondary" style="width: auto;" onclick="closeQR()">Close</button>
</div>

<div class="container">
    <header>
        <div>
            <h1>Major Incident <span id="mode-indicator" class="mode-badge" style="display:none;"></span></h1>
        </div>
        <div class="header-controls">
            <button class="icon-btn" onclick="toggleBlackout()">Blackout</button>
            <button class="icon-btn" onclick="toggleNightMode()">&#9790;</button>
        </div>
    </header>

    <div class="status-bar">
        <span class="status-item" id="header-callsign">Device: -</span>
        <span class="status-item" id="header-role" style="font-weight:bold;"></span>
        <span class="status-item" id="header-sector" style="color:var(--nhs-yellow);"></span>
        <span id="gps-indicator" class="gps-status gps-inactive" style="margin-left: auto;">GPS: Searching...</span>
    </div>

    <!-- PERSISTENT GLOBAL DASHBOARD -->
    <div id="global-dashboard" class="dashboard">
        <div class="dash-card dash-p1"><span class="dash-label">P1</span><span class="dash-num" id="count-p1">0</span></div>
        <div class="dash-card dash-p2"><span class="dash-label">P2</span><span class="dash-num" id="count-p2">0</span></div>
        <div class="dash-card dash-p3"><span class="dash-label">P3</span><span class="dash-num" id="count-p3">0</span></div>
        <div class="dash-card dash-dead"><span class="dash-label">DEAD</span><span class="dash-num" id="count-dead">0</span></div>
        <div class="dash-card dash-evac" style="display:none; font-size:0.8rem;" id="evac-summary">Evacuated: 0 | On Scene: 0</div>
    </div>

    <main>
        
        <!-- INTRO SCREEN -->
        <div id="intro-screen" class="screen active">
            <h2>Configuration</h2>
            
            <button id="btn-resume-log" class="btn btn-secondary" style="display:none; margin-bottom:1.5rem; border:2px solid var(--nhs-blue);" onclick="showLog()">
                &#128196; View Existing Log (<span id="resume-count">0</span>)
            </button>

            <div class="input-group">
                <label>Device Call Sign (Recommended)</label>
                <input type="text" id="intro-callsign" placeholder="e.g. ALPHA-1" autocomplete="off">
            </div>
            
            <div class="input-group">
                <label>Sector / Zone</label>
                <div style="display:flex; gap:5px;">
                    <select id="intro-sector-select" onchange="updateSectorInput()">
                        <option value="">Select or Type...</option>
                        <option value="Inner Cordon">Inner Cordon</option>
                        <option value="Casualty Clearing">Casualty Clearing</option>
                        <option value="Loading Point">Loading Point</option>
                        <option value="Triage Sieve">Triage Sieve</option>
                        <option value="Decon">Decon</option>
                    </select>
                    <button class="btn btn-secondary" style="width:40px; padding:0;" onclick="addCustomSector()">+</button>
                </div>
                <input type="text" id="intro-sector" placeholder="Or type manually..." style="margin-top:5px;" autocomplete="off">
            </div>

            <p><strong>Select Role:</strong></p>

            <button class="btn btn-primary" style="padding: 1.2rem;" onclick="setUserRole('HCP')">
                Healthcare Professional<br>
                <span style="font-size:0.9rem; font-weight:normal;">Doctor, Nurse, Paramedic</span>
            </button>

            <button class="btn btn-secondary" style="padding: 1.2rem;" onclick="setUserRole('NON_HCP')">
                Non-Clinical / First Aid<br>
                <span style="font-size:0.9rem; font-weight:normal;">Police, Fire, First Responder</span>
            </button>
        </div>

        <!-- HOME SCREEN -->
        <div id="home-screen" class="screen">
            <div style="text-align:center; margin-bottom: 1.5rem;">
                <p>Select Action:</p>
            </div>
            
            <button class="btn btn-primary" onclick="initiateTriage('TST')">
                Ten Second Triage (TST)<br>
                <span style="font-size:0.9rem; font-weight:normal;">Rapid Primary Triage</span>
            </button>
            
            <button id="btn-mitt" class="btn btn-primary" onclick="initiateTriage('MITT')">
                Major Incident Triage Tool (MITT)<br>
                <span style="font-size:0.9rem; font-weight:normal;">Secondary Clinical Triage</span>
            </button>

            <button class="btn btn-secondary" onclick="showMethane()">
                METHANE Report<br>
                <span style="font-size:0.9rem; font-weight:normal;">Major Incident Declaration</span>
            </button>

            <div style="margin-top: auto;">
                <button class="btn btn-secondary" onclick="showLog()">View Log & Dashboard</button>
                <button class="btn btn-secondary" style="background-color: #333;" onclick="resetApp()">Change Role / ID</button>
            </div>
        </div>

        <!-- TRIAGE QUESTION SCREEN -->
        <div id="question-screen" class="screen">
            <h2 id="question-header">Assessment</h2>
            <p>Patient: <strong id="q-patient-id" class="editable-id" onclick="editPatientId()">...</strong></p>
            
            <div id="clinical-instruction-box" class="clinical-note" style="display:none;"></div>

            <div class="instruction-card" id="question-text">
                Question goes here?
            </div>

            <!-- YES/NO BUTTONS -->
            <div style="margin-top: auto;">
                <button class="btn btn-yes" onclick="handleAnswer(true)">YES</button>
                <button class="btn btn-no" onclick="handleAnswer(false)">NO</button>
                <button id="btn-back" class="btn btn-secondary" style="margin-top:10px; padding:0.8rem; background-color:#666;" onclick="stepBack()">&#8617; Back</button>
                <button class="btn btn-secondary" style="margin-top:1rem; padding: 0.8rem;" onclick="resetToHome()">Cancel Case</button>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen" class="screen">
            <h2>Triage Result</h2>
            <div style="display:flex; justify-content:center; gap:10px; align-items:center;">
                <p>ID: <strong id="r-patient-id" class="editable-id" onclick="editPatientId(true)"></strong></p>
                <button class="btn btn-secondary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="generateQR()">Show QR</button>
            </div>
            
            <div id="result-tag" class="triage-tag">
                <span id="tag-text">P1</span>
                <div id="hr-badge" class="hr-badge" style="display:none;">HIGH RISK</div>
            </div>
            
            <div id="action-box" class="clinical-note" style="font-size: 1.1rem; font-weight: bold; text-align: center; border-color: var(--nhs-red); color: var(--nhs-red);">
                <!-- Actions -->
            </div>
            
            <div style="text-align:center; font-size:0.8rem; margin-bottom:1rem;">
                GPS: <span id="location-status-text">...</span>
            </div>

            <button id="btn-toggle-details" class="btn btn-secondary" onclick="toggleDetails()">+ Interventions & Notes</button>

            <!-- INLINE DETAILS CONTAINER -->
            <div id="details-container">
                <h3>Interventions</h3>
                <div class="int-grid">
                    <button class="int-btn" data-type="Tourniquet" onclick="recordIntervention(this, 'Tourniquet')">Tourniquet<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Wound Packing" onclick="recordIntervention(this, 'Wound Packing')">Wound Packing<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Airway Open" onclick="recordIntervention(this, 'Airway Open')">Airway Open<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Recovery Pos" onclick="recordIntervention(this, 'Recovery Pos')">Recovery Pos<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Chest Seal" onclick="recordIntervention(this, 'Chest Seal')">Chest Seal<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Needle Decomp" onclick="recordIntervention(this, 'Needle Decomp')">Needle Decomp<span class="int-time"></span></button>
                </div>

                <h3>Clinical Notes</h3>
                <button class="btn btn-secondary" style="margin-bottom:10px;" onclick="openBodyMap()">&#128100; Mark Injury on Body Map</button>
                
                <div class="input-group">
                    <label>Category Override</label>
                    <select id="p-cat-override" onchange="autoSave()">
                        <option value="P1">P1 - Immediate</option>
                        <option value="P2">P2 - Urgent</option>
                        <option value="P3">P3 - Delayed</option>
                        <option value="DEAD">DEAD - Expectant</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Demographics</label>
                    <input type="text" id="p-demos" placeholder="Age / Gender (e.g. 35M)" onblur="autoSave()">
                </div>

                <div class="input-group">
                    <label>Allergies</label>
                    <input type="text" id="p-allergies" placeholder="e.g. Penicillin" onblur="autoSave()">
                </div>

                <div class="input-group">
                    <label>Notes</label>
                    <textarea id="p-notes" rows="3" placeholder="Injuries, mechanism etc." onblur="autoSave()"></textarea>
                    <button class="voice-btn" onclick="startVoice('p-notes')">&#127908;</button>
                </div>

                <div id="risk-container" style="display:none; margin-bottom: 1rem;">
                     <label style="display:flex; align-items:center; gap:10px; font-weight:bold; color:var(--nhs-red); padding:10px; border:1px solid var(--nhs-red); border-radius:4px;">
                        <input type="checkbox" id="risk-check" style="width:24px; height:24px;" onchange="autoSave()">
                        HIGH RISK OF DETERIORATION
                     </label>
                </div>

                <div style="border-top:1px solid #ccc; padding-top:10px; margin-top:10px;">
                    <h3>Transport / Evacuation</h3>
                    <div class="input-group">
                        <label>Vehicle Call Sign</label>
                        <input type="text" id="p-evac-vehicle" placeholder="e.g. AMB-404" onblur="autoSave()">
                    </div>
                    <button id="btn-evac" class="btn btn-evac" onclick="toggleEvac()">Mark as EVACUATED</button>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:1rem;">
                <button class="btn btn-primary" onclick="nextPatient()">NEXT PATIENT &rarr;</button>
                <button class="btn btn-secondary" onclick="showLog()">View Log</button>
            </div>
        </div>

        <!-- METHANE SCREEN -->
        <div id="methane-screen" class="screen">
            <h2>METHANE Report</h2>
            <div class="input-group">
                <label>M - Major Incident Declared?</label>
                <select id="m-decl"><option>Standby</option><option>DECLARED</option><option>Cancelled</option></select>
            </div>
            <div class="input-group">
                <label>E - Exact Location</label>
                <input type="text" id="m-loc">
            </div>
            <div class="input-group">
                <label>T - Type of Incident</label>
                <input type="text" id="m-type">
            </div>
            <div class="input-group">
                <label>H - Hazards</label>
                <input type="text" id="m-haz">
            </div>
            <div class="input-group">
                <label>A - Access</label>
                <input type="text" id="m-acc">
            </div>
            <div class="input-group">
                <label>N - Number of Casualties</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="m-num" type="number" pattern="[0-9]*" style="flex:1;">
                    <button class="btn btn-secondary" style="width:auto; padding:0 10px; margin:0;" onclick="autoFillCasualties()">Auto-Fill</button>
                </div>
            </div>
            <div class="input-group">
                <label>E - Emergency Services Required</label>
                <textarea id="m-svc" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveMethane()">Save Report</button>
            <button class="btn btn-secondary" onclick="resetToHome()">Cancel</button>
        </div>

        <!-- LOG SCREEN -->
        <div id="log-screen" class="screen">
            <h2>Patient Log <small style="font-weight:normal; font-size:0.7rem;">(Tap row to edit)</small></h2>
            
            <div class="log-actions" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;">
                <button class="btn btn-primary" style="flex:1; padding:0.5rem; font-size:0.9rem;" onclick="copyLog()">Copy All (w/ METHANE)</button>
                <button class="btn btn-primary" style="flex:1; padding:0.5rem; font-size:0.9rem;" onclick="downloadCSV()">CSV (w/ METHANE)</button>
            </div>
            
            <div class="log-container">
                <table id="log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>ID</th>
                            <th>Triager</th>
                            <th>Cat</th>
                            <th>Clinical Signs (Reason)</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>

            <div style="margin-top: 1rem; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="resetToHome()">Back</button>
                <button class="btn btn-danger" onclick="clearAllData()">Reset Incident</button>
            </div>
        </div>
    </main>
</div>

<script>
    /* PWA Service Worker Registration */
    if ('serviceWorker' in navigator) {
        try {
            const swContent = `
                const CACHE_NAME = 'mit-triage-v1';
                const urlsToCache = [
                    'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js'
                ];
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => {
                            return cache.addAll(urlsToCache);
                        })
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `;
            const blob = new Blob([swContent], {type: 'application/javascript'});
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.warn('Service Worker failed:', err));
        } catch (e) {
            console.warn('Service Worker setup skipped:', e);
        }
    }

    // --- STATE ---
    let userRole = null; 
    let callSign = "";
    let currentSector = "";
    let currentTool = null;
    let patientCounter = 1;
    let incidentLog = [];
    let currentPatientId = ""; 
    let currentLogIndex = -1; 
    let stepHistory = [];
    
    // GPS State
    let currentPosition = null; 
    let gpsAccuracy = null;
    let watchId = null;

    // --- INITIALIZATION ---
    window.onload = function() {
        initGPS();
        loadLocalData(); 
        updateDashboard();
        if (localStorage.getItem('mit_night_mode') === 'true') {
            document.body.classList.add('night-mode');
        }
    };

    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function initGPS() {
        if ("geolocation" in navigator) {
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    gpsAccuracy = Math.round(position.coords.accuracy);
                    currentPosition = {
                        lat: position.coords.latitude.toFixed(6),
                        lng: position.coords.longitude.toFixed(6),
                        acc: gpsAccuracy
                    };
                    updateGPSIndicator(true);
                },
                (error) => { updateGPSIndicator(false); },
                { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
            );
        } else { document.getElementById('gps-indicator').innerText = "GPS Error"; }
    }

    function updateGPSIndicator(isActive) {
        const el = document.getElementById('gps-indicator');
        if (isActive) {
            el.innerText = `GPS: ±${gpsAccuracy}m`;
            el.className = "gps-status gps-active";
        } else {
            el.innerText = "GPS: No Signal";
            el.className = "gps-status gps-inactive";
        }
    }

    function toggleNightMode() {
        document.body.classList.toggle('night-mode');
        localStorage.setItem('mit_night_mode', document.body.classList.contains('night-mode'));
    }

    function toggleBlackout() {
        const curtain = document.getElementById('blackout-curtain');
        if(curtain.classList.contains('active')) {
             curtain.classList.remove('active');
        } else {
            curtain.classList.add('active');
        }
    }

    // --- PERSISTENCE ---
    function saveLocalData() {
        localStorage.setItem('mit_triage_log', JSON.stringify(incidentLog));
        localStorage.setItem('mit_patient_counter', patientCounter.toString());
        localStorage.setItem('mit_callsign', callSign);
        localStorage.setItem('mit_sector', currentSector);
        if (userRole) localStorage.setItem('mit_user_role', userRole);
        
        const methaneData = {
            m: document.getElementById('m-decl').value,
            e: document.getElementById('m-loc').value,
            t: document.getElementById('m-type').value,
            h: document.getElementById('m-haz').value,
            a: document.getElementById('m-acc').value,
            n: document.getElementById('m-num').value,
            e_svc: document.getElementById('m-svc').value
        };
        localStorage.setItem('mit_methane', JSON.stringify(methaneData));
    }

    function loadLocalData() {
        const savedLog = localStorage.getItem('mit_triage_log');
        const savedCount = localStorage.getItem('mit_patient_counter');
        const savedRole = localStorage.getItem('mit_user_role');
        const savedCallSign = localStorage.getItem('mit_callsign');
        const savedSector = localStorage.getItem('mit_sector');
        const savedMethane = localStorage.getItem('mit_methane');

        if (savedLog) {
            incidentLog = JSON.parse(savedLog);
            if(incidentLog.length > 0) {
                document.getElementById('btn-resume-log').style.display = 'block';
                document.getElementById('resume-count').innerText = incidentLog.length;
            }
        }
        if (savedCount) patientCounter = parseInt(savedCount);
        if (savedCallSign) {
            callSign = savedCallSign;
            document.getElementById('intro-callsign').value = callSign;
            document.getElementById('header-callsign').innerText = callSign ? `Device: ${callSign}` : "Device: -";
        }
        if (savedSector) {
            currentSector = savedSector;
            document.getElementById('intro-sector').value = currentSector;
            document.getElementById('header-sector').innerText = currentSector;
        }
        
        if (savedMethane) {
            const m = JSON.parse(savedMethane);
            document.getElementById('m-decl').value = m.m;
            document.getElementById('m-loc').value = m.e;
            document.getElementById('m-type').value = m.t;
            document.getElementById('m-haz').value = m.h;
            document.getElementById('m-acc').value = m.a;
            document.getElementById('m-num').value = m.n;
            document.getElementById('m-svc').value = m.e_svc;
        }

        if (savedRole) setUserRole(savedRole);
    }

    function clearAllData() {
        if(!confirm("WARNING: This will permanently delete ALL patient logs and settings.\n\nAre you sure you want to reset the entire incident?")) return;
        const confirmCode = prompt("FINAL SECURITY CHECK:\nTo wipe all data, type 'DELETE' below:");
        if(confirmCode === "DELETE") {
            localStorage.clear();
            location.reload(); 
        } else if (confirmCode !== null) {
            showToast("Incorrect code. Data SAFE.");
        }
    }
    
    // --- ROLE & SETUP ---
    function setUserRole(role) {
        userRole = role;
        
        const inputCS = document.getElementById('intro-callsign').value.trim().toUpperCase();
        if(inputCS) callSign = inputCS;
        document.getElementById('header-callsign').innerText = callSign ? `Device: ${callSign}` : "Device: -";
        
        const roleEl = document.getElementById('header-role');
        if(role === 'HCP') {
            roleEl.innerText = "Medic";
            roleEl.style.color = "var(--nhs-green)";
        } else {
            roleEl.innerText = "Non-Medic";
            roleEl.style.color = "var(--text-color)";
        }

        const inputSec = document.getElementById('intro-sector').value.trim();
        if(inputSec) currentSector = inputSec;
        document.getElementById('header-sector').innerText = currentSector;
        
        saveLocalData();
        
        document.getElementById('btn-mitt').style.display = (role === 'NON_HCP') ? 'none' : 'block';
        document.getElementById('risk-container').style.display = (role === 'HCP') ? 'block' : 'none';
        showScreen('home-screen');
    }

    function updateSectorInput() {
        const val = document.getElementById('intro-sector-select').value;
        if(val) document.getElementById('intro-sector').value = val;
    }

    function addCustomSector() {
        const newSec = prompt("Enter new sector name:");
        if(newSec) {
            const opt = document.createElement('option');
            opt.value = newSec;
            opt.innerText = newSec;
            document.getElementById('intro-sector-select').appendChild(opt);
            document.getElementById('intro-sector-select').value = newSec;
            document.getElementById('intro-sector').value = newSec;
        }
    }

    function resetApp() {
        if(confirm("Return to setup? Log data is SAFE.")) showScreen('intro-screen');
    }

    // --- PATIENT ID EDITING ---
    function editPatientId(inResult = false) {
        const newId = prompt("Edit Patient ID:", currentPatientId);
        if(newId && newId.trim() !== "") {
            currentPatientId = newId.trim();
            document.getElementById('q-patient-id').innerText = currentPatientId;
            document.getElementById('r-patient-id').innerText = currentPatientId;
            document.getElementById('d-patient-id').innerText = currentPatientId;
            if(currentLogIndex > -1) {
                incidentLog[currentLogIndex].id = currentPatientId;
                saveLocalData();
            }
        }
    }

    // --- TRIAGE LOGIC ---
    const tstFlow = [
        { id: 'walking', question: "Is the casualty walking?", instruction: "Instruct casualties to move to a safe area.", yes: { type: 'result', category: 'P3', action: "Survivor Reception Centre", reason: "Walking" }, no: { type: 'next', step: 'bleeding' } },
        { id: 'bleeding', question: "Is there severe bleeding?", instruction: "Look for catastrophic haemorrhage.", yes: { type: 'result', category: 'P1', action: "Control Bleeding Immediately", reason: "Catastrophic Bleeding" }, no: { type: 'next', step: 'talking' } },
        { id: 'talking', question: "Is the casualty talking?", instruction: "Can they obey simple commands?", yes: { type: 'next', step: 'penetrating' }, no: { type: 'next', step: 'breathing' } },
        { id: 'penetrating', question: "Is there a penetrating injury to the Head, Neck, Torso or Groin?", instruction: "Check Head, Neck, Torso or Groin.", yes: { type: 'result', category: 'P1', action: "Immediate Priority", reason: "Penetrating Trauma" }, no: { type: 'result', category: 'P2', action: "Urgent Priority", reason: "Casualty Not Walking" } },
        { id: 'breathing', question: "Is the casualty breathing?", instruction: "Open airway. Check for signs of life.", yes: { type: 'result', category: 'P1', action: "Recovery Position", reason: "Unconscious - Breathing" }, no: { type: 'result', category: 'DEAD', action: "Dead (unless resources allow CPR)", reason: "Apnoeic" } }
    ];

    const mittFlow = [
        { id: 'cat_bleed', question: "Is there catastrophic bleeding?", instruction: "Assess for life-threatening haemorrhage.", yes: { type: 'result', category: 'P1', action: "Control Bleeding Immediately", reason: "Catastrophic Bleeding" }, no: { type: 'next', step: 'walking' } },
        { id: 'walking', question: "Is the casualty walking?", instruction: "", yes: { type: 'result', category: 'P3', action: "Minor Injuries Unit", reason: "Walking" }, no: { type: 'next', step: 'breathing' } },
        { id: 'breathing', question: "Is the casualty breathing?", instruction: "Open Airway. (Paeds: 5 rescue breaths if drowning/smoke).", yes: { type: 'next', step: 'voice' }, no: { type: 'result', category: 'DEAD', action: "Confirm Dead", reason: "Apnoeic" } },
        { id: 'voice', question: "Does casualty respond to voice?", instruction: "AVPU Scale: Alert or Voice?", yes: { type: 'next', step: 'age' }, no: { type: 'result', category: 'P1', action: "Unconscious - P1", reason: "Unresponsive to Voice" } },
        { id: 'age', question: "Is the casualty aged over 2 years?", instruction: "Estimate age if unknown.", yes: { type: 'next', step: 'rr' }, no: { type: 'result', category: 'P1', action: "Paediatric Priority (Under 2)", reason: "Age < 2" } },
        { id: 'rr', question: "Is Respiratory Rate 12 - 23?", instruction: "Count breaths per minute.", yes: { type: 'next', step: 'hr' }, no: { type: 'result', category: 'P1', action: "Abnormal Respiration - P1", reason: "RR outside 12-23" } },
        { id: 'hr', question: "Is Heart Rate < 100?", instruction: "Check radial pulse or capillary refill.", yes: { type: 'result', category: 'P2', action: "Stable Physiology - P2", reason: "Stable Physiology" }, no: { type: 'result', category: 'P1', action: "Tachycardic (HR ≥ 100) - P1", reason: "Tachycardia > 100" } }
    ];

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector('main').scrollTop = 0;
        
        const dash = document.getElementById('global-dashboard');
        if(id === 'log-screen') {
            dash.classList.add('expanded');
            // Show Evac summary in expanded mode
            document.getElementById('evac-summary').style.display = 'block';
        } else {
            dash.classList.remove('expanded');
            document.getElementById('evac-summary').style.display = 'none';
        }
    }

    function initiateTriage(tool) {
        currentTool = tool;
        stepHistory = [];
        const prefix = callSign ? `${callSign}-${tool}` : tool;
        currentPatientId = `${prefix}-${pad(patientCounter, 3)}`;
        document.getElementById('q-patient-id').innerText = currentPatientId;
        
        const badge = document.getElementById('mode-indicator');
        badge.innerText = tool;
        badge.style.display = 'inline-block';
        badge.style.backgroundColor = tool === 'MITT' ? '#E87722' : '#007F3B'; 

        if (currentTool === 'TST') loadStep(tstFlow[0]);
        else loadStep(mittFlow[0]);
        showScreen('question-screen');
    }

    function loadStep(stepObj) {
        document.getElementById('question-screen').dataset.stepId = stepObj.id;
        document.getElementById('question-text').innerText = stepObj.question;
        const instructBox = document.getElementById('clinical-instruction-box');
        if (stepObj.instruction) {
            instructBox.style.display = 'block';
            instructBox.innerText = stepObj.instruction;
        } else { instructBox.style.display = 'none'; }
        
        document.getElementById('btn-back').style.display = (stepHistory.length > 0) ? 'block' : 'none';
    }

    function handleAnswer(answer) {
        try {
            const stepId = document.getElementById('question-screen').dataset.stepId;
            stepHistory.push(stepId);
            
            const flow = currentTool === 'TST' ? tstFlow : mittFlow;
            const currentStepObj = flow.find(s => s.id === stepId);
            
            if (!currentStepObj) {
                console.error("Step not found: " + stepId);
                return;
            }

            const outcome = answer ? currentStepObj.yes : currentStepObj.no;

            if (outcome.type === 'next') {
                loadStep(flow.find(s => s.id === outcome.step));
            } else if (outcome.type === 'result') {
                logResult(outcome.category, outcome.action, outcome.reason);
            }
        } catch (err) {
            console.error(err);
            showToast("Error processing answer");
        }
    }
    
    function stepBack() {
        if (stepHistory.length === 0) return;
        const prevStepId = stepHistory.pop();
        const flow = currentTool === 'TST' ? tstFlow : mittFlow;
        loadStep(flow.find(s => s.id === prevStepId));
    }

    function logResult(category, action, reason) {
        const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const timestamp = Date.now(); 
        const entry = {
            id: currentPatientId, 
            time: time, 
            timestamp: timestamp, 
            tool: currentTool, 
            category: category, 
            action: action,
            reason: reason,
            triager: callSign,
            location: currentPosition, 
            sector: currentSector, 
            demos: "", 
            allergies: "", 
            notes: "", 
            highRisk: false, 
            interventions: {}, 
            evacuated: false, 
            evacVehicle: ""
        };

        incidentLog.push(entry);
        currentLogIndex = incidentLog.length - 1; 
        saveLocalData();
        updateDashboard();
        
        renderResultScreen(entry);
    }
    
    function renderResultScreen(entry) {
        document.getElementById('r-patient-id').innerText = entry.id;
        document.getElementById('d-patient-id').innerText = entry.id;
        const tag = document.getElementById('result-tag');
        document.getElementById('tag-text').innerText = entry.category;
        
        tag.className = 'triage-tag'; 
        if (entry.category === 'P1') tag.classList.add('p1');
        else if (entry.category === 'P2') tag.classList.add('p2');
        else if (entry.category === 'P3') tag.classList.add('p3');
        else tag.classList.add('dead');

        document.getElementById('hr-badge').style.display = entry.highRisk ? 'block' : 'none';
        document.getElementById('action-box').innerText = entry.action;
        
        const locText = document.getElementById('location-status-text');
        let displayLoc = currentSector ? `Sec: ${currentSector}` : "";
        if(currentPosition) {
            displayLoc += (displayLoc ? " | " : "") + `${currentPosition.lat}, ${currentPosition.lng}`;
            locText.style.color = "var(--nhs-green)";
        } else {
            if(!displayLoc) { displayLoc = "No GPS / Sector"; locText.style.color = "var(--nhs-red)"; }
            else { locText.style.color = "var(--nhs-blue)"; }
        }
        locText.innerHTML = displayLoc;
        
        document.getElementById('p-cat-override').value = entry.category;
        document.getElementById('p-demos').value = entry.demos;
        document.getElementById('p-allergies').value = entry.allergies;
        document.getElementById('p-notes').value = entry.notes;
        document.getElementById('risk-check').checked = entry.highRisk;
        document.getElementById('p-evac-vehicle').value = entry.evacVehicle || "";
        
        // Evac Button State
        const evacBtn = document.getElementById('btn-evac');
        if(entry.evacuated) {
            evacBtn.innerText = "Mark as ON SCENE (Undo Evac)";
            evacBtn.style.backgroundColor = "#555";
        } else {
            evacBtn.innerText = "Mark as EVACUATED";
            evacBtn.style.backgroundColor = "var(--nhs-dark-blue)";
        }
        
        // Reset buttons state
        document.querySelectorAll('.int-btn').forEach(btn => {
             btn.classList.remove('active');
             btn.querySelector('.int-time').innerText = "";
        });
        
        // Render buttons active state safely
        const intButtons = document.querySelectorAll('.int-btn');
        intButtons.forEach(btn => {
             const type = btn.dataset.type; // Safe usage
             if(entry.interventions && entry.interventions[type]) {
                 btn.classList.add('active');
                 // Display time only
                 btn.querySelector('.int-time').innerText = entry.interventions[type].time;
             }
        });

        document.getElementById('details-container').classList.remove('show');
        document.getElementById('btn-toggle-details').innerText = "+ Interventions & Notes";

        showScreen('result-screen');
    }

    // --- DETAILS, INTERVENTIONS, BODY MAP ---
    function toggleDetails() {
        const container = document.getElementById('details-container');
        const btn = document.getElementById('btn-toggle-details');
        if(container.classList.contains('show')) {
            container.classList.remove('show');
            btn.innerText = "+ Interventions & Notes";
        } else {
            container.classList.add('show');
            btn.innerText = "Hide Details";
            container.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function recordIntervention(btn, type) {
        if(currentLogIndex === -1) return;
        
        const entry = incidentLog[currentLogIndex];
        const timeStr = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const ts = Date.now();
        
        if(!entry.interventions) entry.interventions = {};
        
        if(entry.interventions[type]) {
            delete entry.interventions[type];
            btn.classList.remove('active');
            btn.querySelector('.int-time').innerText = "";
        } else {
            entry.interventions[type] = { time: timeStr, ts: ts };
            btn.classList.add('active');
            btn.querySelector('.int-time').innerText = timeStr;
        }
        saveLocalData();
    }
    
    function toggleEvac() {
        if(currentLogIndex === -1) return;
        const entry = incidentLog[currentLogIndex];
        entry.evacuated = !entry.evacuated;
        entry.evacVehicle = document.getElementById('p-evac-vehicle').value;
        saveLocalData();
        renderResultScreen(entry); // update btn text
    }

    function openBodyMap() {
        document.getElementById('body-map-modal').style.display = 'flex';
    }
    function closeBodyMap() {
        document.getElementById('body-map-modal').style.display = 'none';
    }
    function handleBodyMapClick(evt) {
        if(currentLogIndex === -1) return;
        const svg = document.getElementById('bodymap');
        const pt = svg.createSVGPoint();
        pt.x = evt.clientX; pt.y = evt.clientY;
        const cursorPt = pt.matrixTransform(svg.getScreenCTM().inverse());
        
        // Add X to SVG (visual only for session)
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", cursorPt.x - 5);
        text.setAttribute("y", cursorPt.y + 5);
        text.setAttribute("fill", "red");
        text.setAttribute("font-size", "24");
        text.setAttribute("font-weight", "bold");
        text.textContent = "X";
        svg.appendChild(text);
        
        // Infer location (very basic)
        let loc = "Body";
        if(cursorPt.y < 80) loc = "Head/Neck";
        else if(cursorPt.y > 200) loc = "Legs";
        else loc = "Torso/Arms";
        
        // Append to notes
        const noteField = document.getElementById('p-notes');
        const timestamp = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        noteField.value += ` [Injury marked on ${loc} @ ${timestamp}]`;
        autoSave();
    }

    function startVoice(fieldId) {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("Voice not supported on this browser."); return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = "en-GB";
        recognition.onresult = function(event) {
            document.getElementById(fieldId).value += " " + event.results[0][0].transcript;
            autoSave();
        };
        recognition.onerror = function(event) {
            console.error(event.error);
            showToast("Voice Error: " + event.error);
        };
        recognition.start();
    }
    
    // QR Code
    function generateQR() {
        if(currentLogIndex === -1) return;
        const entry = incidentLog[currentLogIndex];
        const data = `${entry.id}|${entry.category}|${entry.time}|${entry.demos}|${entry.allergies}|${entry.notes}`;
        
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: data, width: 128, height: 128
        });
        document.getElementById('qr-modal').style.display = 'flex';
    }
    function closeQR() { document.getElementById('qr-modal').style.display = 'none'; }

    function autoSave() {
        if(currentLogIndex > -1) {
            const entry = incidentLog[currentLogIndex];
            entry.category = document.getElementById('p-cat-override').value; 
            entry.demos = document.getElementById('p-demos').value;
            entry.allergies = document.getElementById('p-allergies').value;
            entry.notes = document.getElementById('p-notes').value;
            entry.highRisk = document.getElementById('risk-check').checked;
            entry.evacVehicle = document.getElementById('p-evac-vehicle').value;
            
            const tag = document.getElementById('result-tag');
            document.getElementById('tag-text').innerText = entry.category;
            tag.className = 'triage-tag'; 
            if (entry.category === 'P1') tag.classList.add('p1');
            else if (entry.category === 'P2') tag.classList.add('p2');
            else if (entry.category === 'P3') tag.classList.add('p3');
            else tag.classList.add('dead');
            
            document.getElementById('hr-badge').style.display = entry.highRisk ? 'block' : 'none';
            
            saveLocalData();
            updateDashboard();
        }
    }
    
    function editEntry(index) {
        currentLogIndex = index;
        renderResultScreen(incidentLog[index]);
        toggleDetails();
    }

    function showMethane() { showScreen('methane-screen'); }
    
    function autoFillCasualties() {
        let p1=0, p2=0, p3=0, dead=0;
        incidentLog.forEach(e => {
            if(e.category === 'P1') p1++;
            else if(e.category === 'P2') p2++;
            else if(e.category === 'P3') p3++;
            else dead++;
        });
        const summary = `Total: ${incidentLog.length} (P1:${p1}, P2:${p2}, P3:${p3}, Dead:${dead})`;
        document.getElementById('m-num').value = summary;
    }
    
    function saveMethane() { saveLocalData(); showToast("Report Saved"); showScreen('home-screen'); }

    function nextPatient() {
        patientCounter++;
        saveLocalData();
        initiateTriage(currentTool); 
    }

    function resetToHome() { showScreen('home-screen'); }

    function updateDashboard() {
        let p1=0, p2=0, p3=0, dead=0, evac=0;
        incidentLog.forEach(e => {
            if(e.category === 'P1') p1++;
            else if(e.category === 'P2') p2++;
            else if(e.category === 'P3') p3++;
            else dead++;
            if(e.evacuated) evac++;
        });
        document.getElementById('count-p1').innerText = p1;
        document.getElementById('count-p2').innerText = p2;
        document.getElementById('count-p3').innerText = p3;
        document.getElementById('count-dead').innerText = dead;
        
        document.getElementById('evac-summary').innerText = `Evacuated: ${evac} | On Scene: ${incidentLog.length - evac}`;
    }

    function showLog() {
        const tbody = document.getElementById('log-body');
        tbody.innerHTML = '';
        
        const reversedLog = [...incidentLog].map((e, i) => ({...e, originalIndex: i})).reverse();
        const now = Date.now();
        
        reversedLog.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "clickable-row";
            
            // Tourniquet Timer Check (> 2 hours = 7200000ms)
            if(row.interventions && row.interventions['Tourniquet']) {
               const tqTime = row.interventions['Tourniquet'].ts;
               if (tqTime && (now - tqTime > 7200000)) {
                   tr.classList.add('critical-alert');
               }
            }
            
            tr.onclick = function() { editEntry(row.originalIndex); }; 
            
            let catStyle = '';
            if(row.category === 'P1') catStyle = 'background-color:var(--nhs-red); color:white; font-weight:bold;';
            if(row.category === 'P2') catStyle = 'background-color:var(--nhs-yellow);';
            if(row.category === 'P3') catStyle = 'background-color:var(--nhs-green); color:white;';
            if(row.category === 'DEAD') catStyle = 'background-color:#333; color:white;';

            let locText = "";
            if(row.sector) locText += `[${row.sector}] `;
            if(row.location) locText += `${row.location.lat}, ${row.location.lng}`;
            if(!locText) locText = "-";

            let details = "";
            if(row.demos) details += `[${row.demos}] `;
            if(row.allergies) details += `Allergies: ${row.allergies}. `;
            if(row.notes) details += `${row.notes} `;
            if(row.evacuated) details += `<strong>[EVACUATED ${row.evacVehicle}]</strong> `;
            
            if(row.interventions) {
                const ints = Object.entries(row.interventions).map(([k, v]) => `${k}@${v.time}`);
                if(ints.length > 0) details += `<strong>[${ints.join(', ')}]</strong> `;
            }
            
            if(row.highRisk) details = `<span style="color:red; font-weight:bold;">[HIGH RISK]</span> ` + details;

            tr.innerHTML = `
                <td>${row.time}</td>
                <td><strong>${row.id}</strong></td>
                <td>${row.triager || "-"}</td>
                <td style="${catStyle}">${row.category}</td>
                <td><small>${row.reason || "-"}</small></td>
                <td style="font-size:0.75rem;">${locText}</td>
                <td style="font-size:0.8rem;">${details}</td>
            `;
            tbody.appendChild(tr);
        });
        showScreen('log-screen');
    }

    function getMethaneString() {
         const m = JSON.parse(localStorage.getItem('mit_methane') || "{}");
         if(!m.m) return "";
         return `METHANE REPORT\n----------------\nM: ${m.m}\nE: ${m.e}\nT: ${m.t}\nH: ${m.h}\nA: ${m.a}\nN: ${m.n}\nE: ${m.e_svc}\n----------------\n\n`;
    }

    function copyLog() {
        let text = getMethaneString() + "PATIENT LOG\n";
        incidentLog.forEach(r => {
            let intStr = "";
            if(r.interventions) {
                intStr = " INT: " + Object.entries(r.interventions).map(([k,v]) => `${k}(${v.time})`).join(", ");
            }
            
            let locStr = "";
            if (r.sector) locStr += `[Sec:${r.sector}] `;
            if (r.location) locStr += `[GPS:${r.location.lat},${r.location.lng}] `;
            
            let evacStr = r.evacuated ? ` [EVACUATED ${r.evacVehicle}]` : "";
            
            text += `${r.time} | ${r.id} | Triager:${r.triager} | ${r.category} | Reason:${r.reason} | ${r.action} | ${locStr}${r.demos} ${r.notes}${intStr}${evacStr}\n`;
        });
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => showToast("Copied to Clipboard"))
            .catch(() => fallbackCopy(text));
        } else { fallbackCopy(text); }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try { document.execCommand('copy'); showToast("Copied"); } catch (err) {}
        document.body.removeChild(textArea);
    }

    function downloadCSV() {
        const m = JSON.parse(localStorage.getItem('mit_methane') || "{}");
        let csv = "";
        
        if(m.m) {
            csv += `METHANE REPORT\n`;
            csv += `M,${m.m}\nE,${m.e}\nT,${m.t}\nH,${m.h}\nA,${m.a}\nN,${m.n}\nE,${m.e_svc}\n\n`;
        }

        csv += "Time,ID,Triager,Category,Reason,Action,Sector,Lat,Lng,Age/Gender,Allergies,Notes,Interventions,HighRisk,Evacuated,Vehicle\n";
        incidentLog.forEach(r => {
            const lat = r.location ? r.location.lat : "";
            const lng = r.location ? r.location.lng : "";
            const sec = r.sector || "";
            const noteSafe = r.notes.replace(/,/g, " ").replace(/\n/g, " ");
            
            let intStr = "";
            if(r.interventions) {
                intStr = Object.entries(r.interventions).map(([k,v]) => `${k}(${v.time})`).join("; ");
            }
            
            csv += `${r.time},${r.id},${r.triager},${r.category},${r.reason},${r.action},${sec},${lat},${lng},${r.demos},${r.allergies},${noteSafe},${intStr},${r.highRisk},${r.evacuated},${r.evacVehicle}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `incident_log_${new Date().getTime()}.csv`;
        a.click();
        showToast("CSV Downloaded");
    }

    function pad(num, size) {
        num = num.toString();
        while (num.length < size) num = "0" + num;
        return num;
    }
</script>
</body>
</html>
