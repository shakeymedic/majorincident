<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#005EB8">
<meta name="description" content="Major Incident Triage Tool">
<link rel="manifest" href="manifest.json">
<title>Major Incident Triage</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    :root {
        --nhs-blue: #005EB8;
        --nhs-dark-blue: #003087;
        --nhs-green: #007F3B;
        --nhs-red: #DA291C;
        --nhs-yellow: #FAE100;
        --nhs-grey: #4C6272;
        --nhs-pale-grey: #F0F4F5;
        --white: #FFFFFF;
        --black: #212b32;
        --text-color: #212b32;
        --bg-color: #F0F4F5;
        --card-bg: #FFFFFF;
        --toast-bg: #333;
    }

    body.night-mode {
        --nhs-blue: #005EB8;
        --nhs-dark-blue: #000000;
        --nhs-pale-grey: #121212;
        --white: #000000;
        --black: #FFFFFF;
        --text-color: #e0e0e0;
        --bg-color: #000000;
        --card-bg: #1e1e1e;
        --toast-bg: #555;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        -webkit-font-smoothing: antialiased;
        overscroll-behavior-y: none;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        min-height: 100vh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        background-color: var(--card-bg);
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        transition: background-color 0.3s, color 0.3s;
    }

    .card {
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(0,0,0,0.05);
    }

    header {
        background-color: var(--nhs-blue);
        color: white;
        padding: 0.8rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 10;
    }

    h1 { margin: 0; font-size: 1.2rem; font-weight: bold; white-space: nowrap; }
    
    .status-bar {
        background-color: var(--nhs-dark-blue);
        color: white;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        flex-shrink: 0;
        white-space: nowrap;
        overflow-x: auto;
    }

    .status-item { margin-right: 15px; display: inline-flex; align-items: center; gap: 5px; }
    .gps-status { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; background: rgba(255,255,255,0.2); font-weight: bold; }
    .gps-active { color: #ccffcc; border: 1px solid #ccffcc; }
    .gps-inactive { color: #ffcccc; border: 1px solid #ffcccc; }

    .dashboard {
        display: flex;
        width: 100%;
        background: var(--card-bg);
        border-bottom: 1px solid #ccc;
        transition: all 0.3s ease;
        flex-shrink: 0;
        flex-wrap: wrap;
        z-index: 9;
    }

    .dashboard:not(.expanded) { min-height: 50px; }
    .dashboard:not(.expanded) .dash-card {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 5px;
        border-radius: 0;
        font-size: 0.9rem;
        box-shadow: none;
        border-right: 1px solid rgba(0,0,0,0.1);
    }
    .dashboard:not(.expanded) .dash-label { display: inline; font-weight: 500; }
    .dashboard:not(.expanded) .dash-num { display: inline; font-weight: 800; font-size: 1.2rem; }

    .dashboard.expanded {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        padding: 15px;
        height: auto;
        border-bottom: 2px solid #ccc;
    }
    .dashboard.expanded .dash-card {
        padding: 15px 5px;
        text-align: center;
        border-radius: 8px;
        color: black;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        display: block;
    }
    .dashboard.expanded .dash-num { font-size: 1.6rem; display: block; margin-bottom: 4px; }
    .dashboard.expanded .dash-label { font-size: 0.85rem; display: block; text-transform: uppercase; }
    .dashboard.expanded .dash-sub { font-size: 0.75rem; font-weight: normal; display: block; opacity: 0.9; margin-top: 2px; }

    .dash-p1 { background: var(--nhs-red); color: white; }
    .dash-p2 { background: var(--nhs-yellow); color: black; }
    .dash-p3 { background: var(--nhs-green); color: white; }
    .dash-dead { background: #333; color: white; }
    .dash-evac { background: var(--nhs-blue); color: white; grid-column: span 4; }

    main {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch;
    }

    .btn {
        display: block;
        width: 100%;
        padding: 1.4rem;
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        color: white;
        touch-action: manipulation;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.1s, opacity 0.1s;
    }
    .btn:active { opacity: 0.9; transform: scale(0.98); }
    .btn-primary { background-color: var(--nhs-blue); }
    .btn-yes { background-color: var(--nhs-green); font-size: 1.8rem; height: 110px; display: flex; align-items: center; justify-content: center; }
    .btn-no { background-color: var(--nhs-red); font-size: 1.8rem; height: 110px; display: flex; align-items: center; justify-content: center; }
    .btn-secondary { background-color: var(--nhs-grey); }
    .btn-danger { background-color: var(--nhs-red); }
    .btn-evac { background-color: var(--nhs-dark-blue); border: 2px solid var(--nhs-blue); }
    
    .demo-btn { padding: 0.8rem; font-size: 0.9rem; flex: 1; margin-bottom: 0; background-color: var(--nhs-grey); }

    .id-mode-btn.active {
        background-color: var(--nhs-dark-blue);
        border: 2px solid var(--nhs-green);
        position: relative;
    }
    .id-mode-btn.active::after {
        content: "‚úì"; position: absolute; right: 10px; font-size: 1.2em;
    }

    .header-controls { display: flex; gap: 10px; }
    .icon-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.4);
        color: white;
        padding: 10px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        font-weight: bold;
    }

    #blackout-curtain {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: black;
        z-index: 9999;
        display: none;
        color: #333;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        user-select: none;
    }
    #blackout-curtain.active { display: flex; }

    .mode-badge {
        display: inline-block;
        font-size: 0.75rem;
        padding: 3px 10px;
        border-radius: 12px;
        background: rgba(0,0,0,0.3);
        margin-left: 8px;
        vertical-align: middle;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .input-group { margin-bottom: 1.4rem; position: relative; }
    .input-group label { display: block; font-weight: bold; margin-bottom: 0.6rem; color: var(--nhs-blue); font-size: 1.1rem; }
    body.night-mode .input-group label { color: var(--nhs-yellow); }
    .input-group input, .input-group textarea, .input-group select {
        width: 100%;
        padding: 1.2rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 18px;
        font-family: inherit;
        background: var(--card-bg);
        color: var(--text-color);
        -webkit-appearance: none;
    }

    .voice-btn {
        position: absolute;
        right: 12px;
        bottom: 12px;
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        opacity: 0.6;
        padding: 8px;
    }

    .screen { display: none; height: 100%; flex-direction: column; }
    .screen.active { display: flex; }

    .instruction-card {
        background: var(--card-bg);
        border: 1px solid #ccc;
        border-left: 8px solid var(--nhs-blue);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        font-size: 1.6rem;
        font-weight: bold;
        line-height: 1.3;
        color: var(--text-color);
        border-radius: 6px;
    }

    .clinical-note {
        font-size: 1.1rem;
        color: #333;
        background: #fff9e6;
        padding: 1.2rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid #e0c880;
        line-height: 1.4;
    }
    body.night-mode .clinical-note { background: #332b00; color: #fff; border-color: #665500; }

    .clinical-prompt {
        font-size: 1rem;
        color: #003087;
        background: #e6f0fa;
        padding: 1.2rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border-left: 6px solid #005EB8;
        display: none;
    }
    body.night-mode .clinical-prompt {
        background: #001a33;
        color: #cce0ff;
        border-color: #3366cc;
    }
    .clinical-prompt h4 { margin: 0 0 8px 0; font-size: 1.1rem; text-transform: uppercase; font-weight: 800; }
    .clinical-prompt ul { margin: 0; padding-left: 20px; }
    .clinical-prompt li { margin-bottom: 6px; }

    .triage-tag {
        font-size: 5rem;
        font-weight: 900;
        text-align: center;
        padding: 2.5rem 1rem;
        margin: 1rem 0;
        border-radius: 16px;
        border: 6px solid #000;
        position: relative;
        background: var(--card-bg);
        color: var(--text-color);
    }
    body.night-mode .triage-tag { border-color: #fff; }
    
    .triage-label {
        font-size: 1.5rem; display: block; font-weight: normal; margin-top: 5px; text-transform: uppercase;
    }

    .hr-badge {
        position: absolute; top: -15px; right: -10px;
        background: var(--nhs-red); color: white;
        font-size: 1rem; padding: 8px 16px;
        border-radius: 20px; border: 3px solid white;
        font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        z-index: 2;
    }

    .p1 { background-color: var(--nhs-red) !important; color: white !important; }
    .p2 { background-color: var(--nhs-yellow) !important; color: black !important; }
    .p3 { background-color: var(--nhs-green) !important; color: white !important; }
    .dead { background-color: #fff !important; color: black !important; border-color: black !important; }

    .int-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 1.5rem; }
    .int-btn {
        background: var(--card-bg); border: 2px solid var(--nhs-blue); color: var(--nhs-blue);
        padding: 20px 10px; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; font-size: 1.1rem;
        transition: all 0.2s;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .int-btn::before { content: "‚óã"; font-size: 1.4rem; margin-bottom: 4px; }
    .int-btn.active { background: var(--nhs-green); border-color: var(--nhs-green); color: white; }
    .int-btn.active::before { content: "‚úì"; }
    .int-time { display: block; font-size: 0.9rem; font-weight: normal; margin-top: 6px; }

    .log-container { overflow-x: auto; margin-bottom: 1rem; -webkit-overflow-scrolling: touch; border: 1px solid #ccc; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { border: 1px solid #ccc; padding: 12px; text-align: left; vertical-align: top; }
    th { background-color: #e0e0e0; color: black; font-weight: bold; }
    body.night-mode th { background-color: #333; color: white; }
    
    tr { background: var(--card-bg); }
    tr:nth-child(even) { background-color: rgba(0,0,0,0.03); }
    body.night-mode tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }

    tr.clickable-row { cursor: pointer; height: 60px; } 
    tr.clickable-row:active { background-color: rgba(0,119,182, 0.2); }
    
    tr.critical-alert td { 
        background-color: #ffcccc !important; color: #cc0000 !important; font-weight: bold; 
        animation: pulse 2s infinite; 
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    #details-container { border-top: 1px solid #ccc; margin-top: 1.5rem; padding-top: 1.5rem; display: none; }
    #details-container.show { display: block; }
    
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 2000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
    }
    .modal-box {
        background: var(--card-bg); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; color: var(--text-color);
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    
    #body-map-modal svg { max-height: 70vh; max-width: 90vw; background: white; border-radius: 10px; }
    #qrcode { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    #scanner-reader { width: 100%; max-width: 500px; border-radius: 8px; overflow: hidden; background: black; }

    #toast {
        visibility: hidden; min-width: 250px; background-color: var(--toast-bg); color: #fff;
        text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 3000;
        left: 50%; top: 30px; transform: translateX(-50%); font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0; transition: opacity 0.3s, top 0.3s;
    }
    #toast.show { visibility: visible; opacity: 1; top: 50px; }

    .editable-id { border-bottom: 2px dashed var(--nhs-blue); cursor: text; padding-bottom: 2px; }
    .editable-id::after { content: " ‚úé"; font-size: 0.8em; opacity: 0.5; }

    #time-offset-container {
        display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 15px;
    }
    #time-offset {
        padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1.1rem; background: var(--card-bg); color: var(--text-color); width: auto;
    }

    #patient-map { height: 50vh; width: 100%; border-radius: 8px; border: 2px solid #ccc; z-index: 1;}

    @media print {
        header, .btn, .status-bar, .header-controls, #toast, #global-dashboard, .int-grid, .modal-overlay, .voice-btn { display: none !important; }
        .screen { display: none !important; }
        #log-screen { display: block !important; }
        .log-container { overflow: visible; }
        body, .container { background: white; color: black; box-shadow: none; width: 100%; max-width: 100%; min-height: auto; }
        table { font-size: 10pt; width: 100%; border: 1px solid black; }
        th, td { border: 1px solid black; }
    }
</style>
</head>
<body>

<div id="toast">Notification</div>
<div id="blackout-curtain" onclick="toggleBlackout()"></div>

<div id="body-map-modal" class="modal-overlay">
    <h3 style="color:white; margin-bottom:10px;">Tap Injury Location</h3>
    <svg id="bodymap" viewBox="0 0 200 400" width="300" height="500" onclick="handleBodyMapClick(event)">
        <path d="M100,20 C120,20 130,40 130,60 C130,70 120,80 100,80 C80,80 70,70 70,60 C70,40 80,20 100,20 Z" fill="#e0e0e0" stroke="#333" stroke-width="2"/>
        <path d="M70,80 L40,100 L40,200 L60,200 L70,150 L70,250 L90,400 L110,400 L130,250 L130,150 L140,200 L160,200 L160,100 L130,80 Z" fill="#e0e0e0" stroke="#333" stroke-width="2"/>
    </svg>
    <button class="btn btn-secondary" style="width: auto; margin-top: 20px;" onclick="closeBodyMap()">Done</button>
</div>

<div id="manual-id-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>Enter Patient ID</h3>
        <p>Type ID from tag or wristband:</p>
        <div class="input-group">
            <input type="text" id="manual-id-input" placeholder="e.g. T1234">
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="submitManualId()">Start Triage</button>
            <button class="btn btn-secondary" onclick="closeManualId()">Cancel</button>
        </div>
    </div>
</div>

<div id="tod-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:var(--nhs-red);">Confirm Deceased</h3>
        <p>Please declare Time of Death for the record:</p>
        <div class="input-group">
            <label>Time of Death (24h)</label>
            <input type="time" id="tod-input">
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-danger" onclick="confirmDeath()">Confirm DEAD</button>
            <button class="btn btn-secondary" onclick="closeTodModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="atmist-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--nhs-blue);">ATMIST Handover</h3>
        <div id="atmist-content" style="font-size:1.1rem; line-height:1.6;"></div>
        <button class="btn btn-primary" style="margin-top:15px;" onclick="closeAtmist()">Close</button>
    </div>
</div>

<div id="scanner-modal" class="modal-overlay">
    <div class="modal-box" style="width:95%; max-width:600px; padding:10px; display:flex; flex-direction:column; align-items:center;">
        <h3 id="scan-title" style="margin-bottom:5px;">Scan</h3>
        <p id="scan-instruction" style="margin-bottom:10px;">Position code in box</p>
        <div id="scanner-reader"></div>
        <button class="btn btn-secondary" style="width: 100%; margin-top:15px;" onclick="stopScanner()">Cancel</button>
    </div>
</div>

<div id="qr-modal" class="modal-overlay">
    <div class="modal-box" style="display:flex; flex-direction:column; align-items:center;">
        <h3 id="qr-title">Patient Data</h3>
        <div id="qrcode"></div>
        <p id="qr-desc">Scan to transfer data</p>
        <button class="btn btn-secondary" style="width: 100%; margin-top:10px;" onclick="closeQR()">Close</button>
    </div>
</div>

<div class="container">
    <header>
        <div>
            <h1>Major Incident <span id="mode-indicator" class="mode-badge" style="display:none;"></span></h1>
        </div>
        <div class="header-controls">
            <button class="icon-btn" onclick="resetToHome()" aria-label="Home">üè†</button>
            <button class="icon-btn" onclick="toggleBlackout()" aria-label="Blackout Mode">Blackout</button>
            <button class="icon-btn" onclick="toggleNightMode()" aria-label="Night Mode">‚òæ</button>
        </div>
    </header>

    <div class="status-bar">
        <span class="status-item" id="header-user">User: -</span>
        <span class="status-item" id="header-role" style="font-weight:bold;"></span>
        <span class="status-item" id="header-sector" style="color:var(--nhs-yellow);"></span>
        <span id="gps-indicator" class="gps-status gps-inactive" style="margin-left: auto;">GPS: Searching...</span>
    </div>

    <div id="global-dashboard" class="dashboard">
        <div class="dash-card dash-p1">
            <span class="dash-label">P1</span>
            <span class="dash-num" id="count-p1">0 / 0</span>
            <span class="dash-sub">(On Scene)</span>
        </div>
        <div class="dash-card dash-p2">
            <span class="dash-label">P2</span>
            <span class="dash-num" id="count-p2">0 / 0</span>
            <span class="dash-sub">(On Scene)</span>
        </div>
        <div class="dash-card dash-p3">
            <span class="dash-label">P3</span>
            <span class="dash-num" id="count-p3">0 / 0</span>
            <span class="dash-sub">(On Scene)</span>
        </div>
        <div class="dash-card dash-dead">
            <span class="dash-label">DEAD</span>
            <span class="dash-num" id="count-dead">0 / 0</span>
            <span class="dash-sub">(On Scene)</span>
        </div>
        <div class="dash-card dash-evac" style="display:none; font-size:0.9rem;" id="evac-summary">
            Evacuated: 0 | On Scene: 0
        </div>
    </div>

    <main>
        <div id="intro-screen" class="screen" style="padding: 2rem;">
            <h2 style="margin-bottom:1.5rem;">Configuration</h2>
            
            <button id="btn-resume-log" class="btn btn-secondary" style="display:none; margin-bottom:2rem; border:2px solid var(--nhs-blue);" onclick="showLog()">
                üìã View Existing Log (<span id="resume-count">0</span>)
            </button>

            <div class="card">
                <div class="input-group">
                    <label>Triager Name / Call Sign (Required)</label>
                    <input type="text" id="intro-triager" placeholder="e.g. Dr Smith, Medic 1" autocomplete="off">
                </div>

                <div class="input-group">
                    <label>Patient ID Mode</label>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-secondary id-mode-btn active" id="mode-auto" style="flex:1;" onclick="setIdMode('AUTO')">Auto-Generate</button>
                        <button class="btn btn-secondary id-mode-btn" id="mode-manual" style="flex:1;" onclick="setIdMode('MANUAL')">Manual Entry</button>
                    </div>
                    <div id="prefix-container" style="margin-top:15px;">
                        <label style="font-size:0.9rem;">ID Prefix (Optional)</label>
                        <input type="text" id="intro-device-prefix" placeholder="e.g. DEVICE-A (Default: Tool Name)" autocomplete="off">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Sector / Zone</label>
                    <div style="display:flex; gap:5px;">
                        <select id="intro-sector-select" onchange="updateSectorInput()">
                            <option value="">Select or Type...</option>
                            <option value="Inner Cordon">Inner Cordon</option>
                            <option value="Casualty Clearing">Casualty Clearing</option>
                            <option value="Loading Point">Loading Point</option>
                            <option value="Triage Sieve">Triage Sieve</option>
                            <option value="Decon">Decon</option>
                        </select>
                        <button class="btn btn-secondary" style="width:50px; padding:0;" onclick="addCustomSector()">+</button>
                    </div>
                    <input type="text" id="intro-sector" placeholder="Or type manually..." style="margin-top:8px;" autocomplete="off">
                </div>
            </div>

            <p style="margin-top:1rem; font-weight:bold;">Select Role:</p>

            <button class="btn btn-primary" style="padding: 1.5rem;" onclick="setUserRole('HCP')">
                Healthcare Professional<br>
                <span style="font-size:0.9rem; font-weight:normal;">Doctor, Nurse, Paramedic</span>
            </button>

            <button class="btn btn-secondary" style="padding: 1.5rem;" onclick="setUserRole('NON_HCP')">
                Non-Clinical / First Aid<br>
                <span style="font-size:0.9rem; font-weight:normal;">Police, Fire, First Responder</span>
            </button>
        </div>

        <div id="home-screen" class="screen">
            <div style="text-align:center; margin-bottom: 2rem;">
                <p style="font-size:1.2rem;">Select Action:</p>
            </div>
            
            <button class="btn btn-primary" onclick="initiateTriage('TST')">
                Ten Second Triage (TST)<br>
                <span style="font-size:0.9rem; font-weight:normal;">Rapid Primary Triage</span>
            </button>
            
            <button id="btn-mitt" class="btn btn-primary" onclick="initiateTriage('MITT')">
                Major Incident Triage Tool (MITT)<br>
                <span style="font-size:0.9rem; font-weight:normal;">Secondary Clinical Triage</span>
            </button>

            <div style="display:flex; gap:10px; margin-bottom:1rem;">
                <button class="btn btn-secondary" style="flex:1; background-color: var(--nhs-dark-blue); font-size:1rem;" onclick="scanPatientQR()">
                    Receive Patient<br><span style="font-size:0.8rem; font-weight:normal;">Scan QR Data</span>
                </button>
                <button class="btn btn-secondary" style="flex:1; font-size:1rem;" onclick="generateMyIdentityQR()">
                    My ID<br><span style="font-size:0.8rem; font-weight:normal;">Scan for bulk handover</span>
                </button>
            </div>

            <button class="btn btn-secondary" style="background-color: var(--nhs-green); color: white;" onclick="showMap()">
                üó∫Ô∏è View Patient Map
            </button>

            <button class="btn btn-secondary" onclick="showMethane()">
                METHANE Report<br>
                <span style="font-size:0.9rem; font-weight:normal;">Major Incident Declaration</span>
            </button>

            <div style="margin-top: auto;">
                <button class="btn btn-secondary" onclick="showLog()">View Log & Dashboard</button>
                <button class="btn btn-secondary" style="background-color: #333;" onclick="resetApp()">Change Role / ID</button>
            </div>
        </div>

        <div id="question-screen" class="screen">
            <h2 id="question-header">Assessment</h2>
            <p style="font-size:1.1rem;">Patient: <strong id="q-patient-id" class="editable-id" onclick="editPatientId()">...</strong></p>
            
            <div id="clinical-instruction-box" class="clinical-note" style="display:none;"></div>

            <div class="instruction-card" id="question-text">
                Question goes here?
            </div>

            <div style="margin-top: auto;">
                <button class="btn btn-yes" onclick="handleAnswer(true)">YES</button>
                <button class="btn btn-no" onclick="handleAnswer(false)">NO</button>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button id="btn-back" class="btn btn-secondary" style="flex:1; background-color:#666;" onclick="stepBack()">‚Ü© Back</button>
                    <button class="btn btn-secondary" style="flex:1;" onclick="confirmCancelCase()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="screen">
            <h2>Triage Result</h2>
            <div style="display:flex; justify-content:center; gap:15px; align-items:center;">
                <p style="font-size:1.2rem;">ID: <strong id="r-patient-id" class="editable-id" onclick="editPatientId(true)"></strong></p>
            </div>
            
            <div id="result-tag" class="triage-tag">
                <span id="tag-text">P1</span>
                <span class="triage-label" id="tag-label">IMMEDIATE</span>
                <div id="hr-badge" class="hr-badge" style="display:none;">HIGH RISK</div>
            </div>

            <div id="clinical-prompts" class="clinical-prompt"></div>
            
            <div id="action-box" class="clinical-note" style="font-size: 1.1rem; font-weight: bold; text-align: center; border-color: var(--nhs-red); color: var(--nhs-red);">
            </div>
            
            <div style="text-align:center; font-size:0.9rem; margin-bottom:1rem;">
                GPS: <span id="location-status-text">...</span>
            </div>

            <button class="btn btn-primary" style="margin-bottom:15px;" onclick="generatePatientQR()">
                üì± Handover Data (Show QR)
            </button>

            <button id="btn-toggle-details" class="btn btn-secondary" onclick="toggleDetails()">+ Interventions & Notes</button>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="btn-retriage" class="btn btn-secondary" style="flex:1; border:2px solid var(--nhs-blue); color: var(--nhs-blue); background: var(--card-bg);" onclick="reTriage()">‚Üª Re-Triage</button>
                <button id="btn-atmist" class="btn btn-secondary" style="flex:1; border:2px solid var(--nhs-green); color: var(--nhs-green); background: var(--card-bg);" onclick="generateAtmist()">üì¢ ATMIST</button>
            </div>

            <div id="details-container">
                <div id="time-offset-container">
                    <label style="font-size:0.9rem; font-weight:bold;">Time of Event:</label>
                    <select id="time-offset">
                        <option value="0">Now (Real-time)</option>
                        <option value="5">5 mins ago</option>
                        <option value="10">10 mins ago</option>
                        <option value="15">15 mins ago</option>
                        <option value="30">30 mins ago</option>
                        <option value="60">1 hour ago</option>
                    </select>
                </div>

                <h3>Interventions</h3>
                <div class="int-grid">
                    <button class="int-btn" data-type="Tourniquet" onclick="recordIntervention(this, 'Tourniquet')">Tourniquet<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Wound Packing" onclick="recordIntervention(this, 'Wound Packing')">Wound Packing<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Airway Open" onclick="recordIntervention(this, 'Airway Open')">Airway Open<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Recovery Pos" onclick="recordIntervention(this, 'Recovery Pos')">Recovery Pos<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Chest Seal" onclick="recordIntervention(this, 'Chest Seal')">Chest Seal<span class="int-time"></span></button>
                    <button class="int-btn" data-type="Needle Decomp" onclick="recordIntervention(this, 'Needle Decomp')">Needle Decomp<span class="int-time"></span></button>
                </div>

                <h3>Clinical Notes</h3>
                <button class="btn btn-secondary" style="margin-bottom:15px;" onclick="openBodyMap()">üë§ Mark Injury on Body Map</button>
                
                <div class="card">
                    <div class="input-group">
                        <label>Sector / Location</label>
                        <input type="text" id="p-sector" placeholder="e.g. CCS, Inner Cordon" onblur="autoSave('Sector Update')">
                    </div>

                    <div class="input-group">
                        <label>Category Override</label>
                        <select id="p-cat-override" onchange="autoSave('Category Override')">
                            <option value="P1">P1 - IMMEDIATE</option>
                            <option value="P2">P2 - URGENT</option>
                            <option value="P3">P3 - DELAYED</option>
                            <option value="DEAD">DEAD - EXPECTANT</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Demographics</label>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <button class="btn demo-btn" onclick="addDemoText('Adult')">Adult</button>
                            <button class="btn demo-btn" onclick="addDemoText('Child')">Child</button>
                            <button class="btn demo-btn" onclick="addDemoText('Male')">Male</button>
                            <button class="btn demo-btn" onclick="addDemoText('Female')">Female</button>
                        </div>
                        <input type="text" id="p-demos" placeholder="Age / Gender (e.g. 35M)" onblur="autoSave('Demographics Update')">
                    </div>

                    <div class="input-group">
                        <label>Allergies</label>
                        <input type="text" id="p-allergies" placeholder="e.g. Penicillin" onblur="autoSave('Allergies Update')">
                    </div>

                    <div class="input-group">
                        <label>Notes</label>
                        <textarea id="p-notes" rows="3" placeholder="Injuries, mechanism etc." onblur="autoSave('Notes Update')"></textarea>
                        <button class="voice-btn" onclick="startVoice('p-notes')">üéô</button>
                    </div>
                </div>

                <div id="risk-container" style="display:none; margin-bottom: 1.5rem;">
                     <label style="display:flex; align-items:center; gap:15px; font-weight:bold; color:var(--nhs-red); padding:15px; border:2px solid var(--nhs-red); border-radius:8px; background: rgba(218, 41, 28, 0.05);">
                        <input type="checkbox" id="risk-check" style="width:28px; height:28px;" onchange="autoSave('High Risk Flag')">
                        HIGH RISK OF DETERIORATION
                     </label>
                </div>

                <div class="card" style="border-top: 4px solid var(--nhs-dark-blue);">
                    <h3>Transport / Evacuation</h3>
                    <div class="input-group">
                        <label>Destination</label>
                        <input type="text" id="p-evac-dest" placeholder="e.g. Royal Infirmary, CCS">
                    </div>
                    <div class="input-group">
                        <label>Handover To / Vehicle</label>
                        <input type="text" id="p-evac-vehicle" placeholder="e.g. AMB-404, HART Team 1">
                    </div>
                    
                    <button class="btn btn-secondary btn-handover" style="margin-bottom:10px; background-color:#555;" onclick="scanHandover()">
                        Transfer Care (Scan Colleague ID)
                    </button>
                    
                    <button id="btn-evac" class="btn btn-evac" onclick="toggleEvac()">Mark as EVACUATED</button>
                </div>
            </div>

            <div style="margin-top:auto; padding-top:1.5rem;">
                <button class="btn btn-primary" onclick="nextPatient()">NEXT PATIENT ‚Üí</button>
                <button class="btn btn-secondary" onclick="showLog()">View Log</button>
            </div>
        </div>

        <div id="map-screen" class="screen">
            <h2>Patient Locations</h2>
            <div id="patient-map"></div>
            <div style="padding: 1rem 0;">
                <button class="btn btn-primary" onclick="resetToHome()">Back to Home</button>
            </div>
        </div>

        <div id="methane-screen" class="screen">
            <h2>METHANE Report</h2>
            <div class="input-group">
                <label>M - Major Incident Declared?</label>
                <select id="m-decl"><option>Standby</option><option>DECLARED</option><option>Cancelled</option></select>
            </div>
            <div class="input-group">
                <label>E - Exact Location</label>
                <input type="text" id="m-loc">
            </div>
            <div class="input-group">
                <label>T - Type of Incident</label>
                <input type="text" id="m-type">
            </div>
            <div class="input-group">
                <label>H - Hazards</label>
                <input type="text" id="m-haz">
            </div>
            <div class="input-group">
                <label>A - Access</label>
                <input type="text" id="m-acc">
            </div>
            <div class="input-group">
                <label>N - Number of Casualties</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="m-num" type="text" style="flex:1;">
                    <button class="btn btn-secondary" style="width:auto; padding:0 10px; margin:0;" onclick="autoFillCasualties()">Auto-Fill</button>
                </div>
            </div>
            <div class="input-group">
                <label>E - Emergency Services Required</label>
                <textarea id="m-svc" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveMethane()">Save Report</button>
            <button class="btn btn-secondary" style="margin-top:5px; background:#666;" onclick="showMethaneHistory()">View History</button>
            <button class="btn btn-secondary" onclick="resetToHome()">Cancel</button>
        </div>

        <div id="methane-history-screen" class="screen">
            <h2>METHANE History</h2>
            <div id="methane-history-list" style="flex:1; overflow-y:auto;"></div>
            <button class="btn btn-primary" onclick="showMethane()">Back to Editor</button>
        </div>

        <div id="log-screen" class="screen">
            <h2>Patient Log <small style="font-weight:normal; font-size:0.9rem;">(Tap row to edit)</small></h2>
            
            <div class="log-actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                <button class="btn btn-primary" style="flex:1; padding:0.8rem; font-size:0.9rem;" onclick="downloadCSV('SNAPSHOT')">Casualty Register (CSV)</button>
                <button class="btn btn-primary" style="flex:1; padding:0.8rem; font-size:0.9rem;" onclick="downloadCSV('AUDIT')">Forensic Audit Trail (CSV)</button>
            </div>
            
            <div class="log-container">
                <table id="log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>ID</th>
                            <th>Triager</th>
                            <th>Cat</th>
                            <th>Clinical Signs (Reason)</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>

            <div style="margin-top: 1rem; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="resetToHome()">Back</button>
                <button class="btn btn-danger" onclick="clearAllData()">Reset Incident</button>
            </div>
        </div>
    </main>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker Registered'))
                .catch(err => console.warn('Service Worker setup skipped:', err));
        });
    }

    let wakeLock = null;

    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
            } catch (err) {
                console.warn('Wake Lock error:', err);
            }
        }
    }

    document.addEventListener('visibilitychange', () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            requestWakeLock();
        }
    });

    const clinicalPrompts = {
        "Catastrophic Bleeding": [
            "CRITICAL: STOP THE BLEED",
            "Apply Tourniquet / Pelvic Binder",
            "Haemostatic Dressings",
            "Consider TXA (if >4 units blood likely)",
            "Massive Haemorrhage Protocol",
            "Correction of Hypothermia"
        ],
        "Unresponsive to Voice": [
            "Airway Threat - Protect Airway",
            "Consider Advanced Airway (iGel/LMA/Intubation)",
            "Recovery Position (if airway safe)",
            "Neurosurgery for Intra-cranial Haemorrhage?",
            "Correction of Low Blood Glucose"
        ],
        "RR outside 12-23": [
            "Chest/Breathing Injury?",
            "Consider Thoracostomy (Needle/Finger/Drain)",
            "Consider Chest Seal",
            "Non-Invasive Positive Pressure Vent (NIPPV)",
            "Resuscitative Thoracostomy (if traumatic arrest)",
            "Spinal Nursing (C1-C3 risk?)"
        ],
        "Tachycardia > 100": [
            "Circulatory Shock?",
            "Support Volume Resuscitation (Blood/Vasopressors)",
            "Consider TXA",
            "Vascular Surgery (Uncontrolled Haemorrhage)",
            "Laparotomy/Thoracotomy (Torso Trauma)"
        ],
        "Penetrating Trauma": [
            "Rapid Evacuation to Theatre",
            "Damage Control Surgery",
            "Stop Bleeding",
            "Chest Seal for Torso Wounds"
        ],
         "Unconscious - Breathing": [
            "Airway Protected?",
            "Recovery Position",
            "Monitor GCS",
            "Spinal Precautions"
        ],
        "Age < 2": [
            "Consider Specialist Paediatric Care",
            "Warmth / Hypothermia Prevention",
            "Glucose Check"
        ]
    };

    let userRole = null; 
    let triagerName = "";
    let devicePrefix = "";
    let currentSector = "";
    let currentTool = null;
    let patientCounter = 1;
    let incidentLog = [];
    let auditLog = [];
    let methaneHistory = [];
    let currentPatientId = ""; 
    let currentLogIndex = -1; 
    let stepHistory = [];
    let idMode = 'AUTO'; 
    let pendingReTriageId = null;
    
    let currentPosition = null; 
    let gpsAccuracy = null;
    let watchId = null;
    let html5QrcodeScanner = null;
    let scanMode = null; 
    let patientMap = null;
    let mapMarkers = [];
    
    let db;
    const request = indexedDB.open("MITT_DB", 1);
    
    request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains('logs')) {
            db.createObjectStore('logs');
        }
    };
    
    request.onsuccess = (event) => {
        db = event.target.result;
        loadLogsFromDB();
    };

    function triggerHaptic(type) {
        if (!navigator.vibrate) return;
        if (type === 'success') navigator.vibrate(200);
        if (type === 'alert') navigator.vibrate([100, 50, 100, 50, 100]);
        if (type === 'tap') navigator.vibrate(50);
    }

    function playBeep() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            osc.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        } catch(e) {}
    }

    window.onload = function() {
        initGPS();
        loadLocalSettings();
        requestWakeLock();
        if (localStorage.getItem('mit_night_mode') === 'true') {
            document.body.classList.add('night-mode');
        }
        
        if (userRole === null) {
            showScreen('intro-screen');
        } else {
            updateDashboard();
            showScreen('home-screen');
        }
    };
    
    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function initGPS() {
        if ("geolocation" in navigator) {
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    gpsAccuracy = Math.round(position.coords.accuracy);
                    currentPosition = {
                        lat: position.coords.latitude.toFixed(6),
                        lng: position.coords.longitude.toFixed(6),
                        acc: gpsAccuracy
                    };
                    updateGPSIndicator(true);
                },
                (error) => { updateGPSIndicator(false); },
                { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
            );
        } else { document.getElementById('gps-indicator').innerText = "GPS Error"; }
    }

    function updateGPSIndicator(isActive) {
        const el = document.getElementById('gps-indicator');
        if (isActive) {
            el.innerText = `GPS: ¬±${gpsAccuracy}m`;
            el.className = "gps-status gps-active";
        } else {
            el.innerText = "GPS: No Signal";
            el.className = "gps-status gps-inactive";
        }
    }

    function toggleNightMode() {
        document.body.classList.toggle('night-mode');
        localStorage.setItem('mit_night_mode', document.body.classList.contains('night-mode'));
    }

    function toggleBlackout() {
        const curtain = document.getElementById('blackout-curtain');
        if(curtain.classList.contains('active')) {
             curtain.classList.remove('active');
        } else {
            curtain.classList.add('active');
        }
    }

    function loadLocalSettings() {
        const savedCount = localStorage.getItem('mit_patient_counter');
        const savedRole = localStorage.getItem('mit_user_role');
        const savedTriager = localStorage.getItem('mit_triager');
        const savedPrefix = localStorage.getItem('mit_device_prefix');
        const savedSector = localStorage.getItem('mit_sector');
        const savedIdMode = localStorage.getItem('mit_id_mode');

        if (savedCount) patientCounter = parseInt(savedCount);
        if (savedTriager) {
            triagerName = savedTriager;
            document.getElementById('intro-triager').value = triagerName;
            document.getElementById('header-user').innerText = `User: ${triagerName}`;
        }
        if (savedPrefix) {
            devicePrefix = savedPrefix;
            document.getElementById('intro-device-prefix').value = devicePrefix;
        }
        if (savedSector) {
            currentSector = savedSector;
            document.getElementById('intro-sector').value = currentSector;
            document.getElementById('header-sector').innerText = currentSector;
        }
        if (savedIdMode) {
            idMode = savedIdMode;
            setIdMode(idMode);
        }
        if (savedRole) setUserRole(savedRole);
    }
    
    function loadLogsFromDB() {
        const tx = db.transaction('logs', 'readonly');
        const store = tx.objectStore('logs');
        
        store.get('incidentLog').onsuccess = (e) => {
            if (e.target.result) {
                incidentLog = e.target.result;
                if(incidentLog.length > 0) {
                    document.getElementById('btn-resume-log').style.display = 'block';
                    document.getElementById('resume-count').innerText = incidentLog.length;
                }
                updateDashboard();
            }
        };
        store.get('auditLog').onsuccess = (e) => {
            if (e.target.result) auditLog = e.target.result;
        };
        store.get('methaneHistory').onsuccess = (e) => {
            if (e.target.result) methaneHistory = e.target.result;
        };
        
        const savedMethane = localStorage.getItem('mit_methane');
        if (savedMethane) {
            const m = JSON.parse(savedMethane);
            document.getElementById('m-decl').value = m.m || "Standby";
            document.getElementById('m-loc').value = m.e || "";
            document.getElementById('m-type').value = m.t || "";
            document.getElementById('m-haz').value = m.h || "";
            document.getElementById('m-acc').value = m.a || "";
            document.getElementById('m-num').value = m.n || "";
            document.getElementById('m-svc').value = m.e_svc || "";
        }
    }

    function saveState() {
        localStorage.setItem('mit_patient_counter', patientCounter.toString());
        localStorage.setItem('mit_triager', triagerName);
        localStorage.setItem('mit_device_prefix', devicePrefix);
        localStorage.setItem('mit_sector', currentSector);
        localStorage.setItem('mit_id_mode', idMode);
        if (userRole) localStorage.setItem('mit_user_role', userRole);
        
        const methaneData = {
            m: document.getElementById('m-decl').value,
            e: document.getElementById('m-loc').value,
            t: document.getElementById('m-type').value,
            h: document.getElementById('m-haz').value,
            a: document.getElementById('m-acc').value,
            n: document.getElementById('m-num').value,
            e_svc: document.getElementById('m-svc').value
        };
        localStorage.setItem('mit_methane', JSON.stringify(methaneData));

        if (!db) return;
        const tx = db.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        store.put(incidentLog, 'incidentLog');
        store.put(auditLog, 'auditLog');
        store.put(methaneHistory, 'methaneHistory');
    }

    function clearAllData() {
        if(!confirm("WARNING: This will permanently delete ALL patient logs and settings.\n\nAre you sure you want to reset the entire incident?")) return;
        const confirmCode = prompt("FINAL SECURITY CHECK:\nTo wipe all data, type 'DELETE' below:");
        if(confirmCode === "DELETE") {
            localStorage.clear();
            if(db) {
                const tx = db.transaction('logs', 'readwrite');
                tx.objectStore('logs').clear();
                tx.oncomplete = () => { location.reload(); };
            } else {
                location.reload();
            }
        } else if (confirmCode !== null) {
            showToast("Incorrect code. Data SAFE.");
        }
    }
    
    function logAudit(actionType, patientId, details, clinicalTime) {
        const sysTime = Date.now();
        const entry = {
            sysTime: sysTime,
            clinTime: clinicalTime || sysTime,
            user: triagerName,
            action: actionType,
            patientId: patientId,
            details: details,
            sector: currentSector,
            gps: currentPosition
        };
        auditLog.push(entry);
    }

    function getClinicalTimestamp() {
        const offsetMins = parseInt(document.getElementById('time-offset').value) || 0;
        return Date.now() - (offsetMins * 60000);
    }

    function setUserRole(role) {
        userRole = role;
        
        const inputTriager = document.getElementById('intro-triager').value.trim();
        if(inputTriager) triagerName = inputTriager;
        document.getElementById('header-user').innerText = `User: ${triagerName || 'Unknown'}`;

        const inputPrefix = document.getElementById('intro-device-prefix').value.trim().toUpperCase();
        if(inputPrefix) devicePrefix = inputPrefix;
        
        const roleEl = document.getElementById('header-role');
        if(role === 'HCP') {
            roleEl.innerText = "Medic";
            roleEl.style.color = "var(--nhs-green)";
        } else {
            roleEl.innerText = "Non-Medic";
            roleEl.style.color = "var(--text-color)";
        }

        const inputSec = document.getElementById('intro-sector').value.trim();
        if(inputSec) currentSector = inputSec;
        document.getElementById('header-sector').innerText = currentSector;
        
        saveState();
        
        document.getElementById('btn-mitt').style.display = (role === 'NON_HCP') ? 'none' : 'block';
        document.getElementById('risk-container').style.display = (role === 'HCP') ? 'block' : 'none';
        showScreen('home-screen');
    }

    function updateSectorInput() {
        const val = document.getElementById('intro-sector-select').value;
        if(val) document.getElementById('intro-sector').value = val;
    }

    function addCustomSector() {
        const newSec = prompt("Enter new sector name:");
        if(newSec) {
            const opt = document.createElement('option');
            opt.value = newSec;
            opt.innerText = newSec;
            document.getElementById('intro-sector-select').appendChild(opt);
            document.getElementById('intro-sector-select').value = newSec;
            document.getElementById('intro-sector').value = newSec;
        }
    }

    function setIdMode(mode) {
        idMode = mode;
        document.querySelectorAll('.id-mode-btn').forEach(btn => btn.classList.remove('active'));
        if(mode === 'AUTO') {
            document.getElementById('mode-auto').classList.add('active');
            document.getElementById('prefix-container').style.display = 'block';
        } else {
            document.getElementById('mode-manual').classList.add('active');
            document.getElementById('prefix-container').style.display = 'none';
        }
        saveState();
    }

    function resetApp() {
        if(confirm("Return to setup? Log data is SAFE.")) showScreen('intro-screen');
    }

    function editPatientId(inResult = false) {
        const newId = prompt("Edit Patient ID:", currentPatientId);
        if(newId && newId.trim() !== "") {
            const oldId = currentPatientId;
            currentPatientId = newId.trim();
            document.getElementById('q-patient-id').innerText = currentPatientId;
            const rEl = document.getElementById('r-patient-id');
            if(rEl) rEl.innerText = currentPatientId;
            
            if(currentLogIndex > -1) {
                incidentLog[currentLogIndex].id = currentPatientId;
                logAudit("ID_CHANGE", currentPatientId, `Changed from ${oldId} to ${currentPatientId}`, getClinicalTimestamp());
                saveState();
            }
        }
    }

    function addDemoText(text) {
        const field = document.getElementById('p-demos');
        const currentVal = field.value.trim();
        if (currentVal) {
            field.value = currentVal + " / " + text;
        } else {
            field.value = text;
        }
        autoSave('Demographics Added');
    }

    const tstFlow = [
        { id: 'walking', question: "Is the casualty walking?", instruction: "Instruct casualties to move to a safe area.", yes: { type: 'result', category: 'P3', action: "Survivor Reception Centre", reason: "Walking" }, no: { type: 'next', step: 'bleeding' } },
        { id: 'bleeding', question: "Is there severe bleeding?", instruction: "Look for catastrophic haemorrhage.", yes: { type: 'result', category: 'P1', action: "Control Bleeding Immediately", reason: "Catastrophic Bleeding" }, no: { type: 'next', step: 'talking' } },
        { id: 'talking', question: "Is the casualty talking?", instruction: "Can they obey simple commands?", yes: { type: 'next', step: 'penetrating' }, no: { type: 'next', step: 'breathing' } },
        { id: 'penetrating', question: "Is there a penetrating injury to the Head, Neck, Torso or Groin?", instruction: "Check Head, Neck, Torso or Groin.", yes: { type: 'result', category: 'P1', action: "Immediate Priority", reason: "Penetrating Trauma" }, no: { type: 'result', category: 'P2', action: "Urgent Priority", reason: "Casualty Not Walking" } },
        { id: 'breathing', question: "Is the casualty breathing?", instruction: "Open airway. Check for signs of life.", yes: { type: 'result', category: 'P1', action: "Recovery Position", reason: "Unconscious - Breathing" }, no: { type: 'result', category: 'DEAD', action: "Dead (unless resources allow CPR)", reason: "Apnoeic" } }
    ];

    const mittFlow = [
        { id: 'cat_bleed', question: "Is there catastrophic bleeding?", instruction: "Assess for life-threatening haemorrhage.", yes: { type: 'result', category: 'P1', action: "Control Bleeding Immediately", reason: "Catastrophic Bleeding" }, no: { type: 'next', step: 'walking' } },
        { id: 'walking', question: "Is the casualty walking?", instruction: "", yes: { type: 'result', category: 'P3', action: "Minor Injuries Unit", reason: "Walking" }, no: { type: 'next', step: 'breathing' } },
        { id: 'breathing', question: "Is the casualty breathing?", instruction: "Open Airway. (Paeds: 5 rescue breaths if drowning/smoke).", yes: { type: 'next', step: 'voice' }, no: { type: 'result', category: 'DEAD', action: "Confirm Dead", reason: "Apnoeic" } },
        { id: 'voice', question: "Does casualty respond to voice?", instruction: "AVPU Scale: Alert or Voice?", yes: { type: 'next', step: 'age' }, no: { type: 'result', category: 'P1', action: "Unconscious - P1", reason: "Unresponsive to Voice" } },
        { id: 'age', question: "Is the casualty aged over 2 years?", instruction: "Estimate age if unknown.", yes: { type: 'next', step: 'rr' }, no: { type: 'result', category: 'P1', action: "Paediatric Priority (Under 2)", reason: "Age < 2" } },
        { id: 'rr', question: "Is Respiratory Rate 12 - 23?", instruction: "Count breaths per minute.", yes: { type: 'next', step: 'hr' }, no: { type: 'result', category: 'P1', action: "Abnormal Respiration - P1", reason: "RR outside 12-23" } },
        { id: 'hr', question: "Is Heart Rate < 100?", instruction: "Check radial pulse or capillary refill.", yes: { type: 'result', category: 'P2', action: "Stable Physiology - P2", reason: "Stable Physiology" }, no: { type: 'result', category: 'P1', action: "Tachycardic (HR ‚â• 100) - P1", reason: "Tachycardia > 100" } }
    ];

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector('main').scrollTop = 0;
        
        const dash = document.getElementById('global-dashboard');
        if(id === 'log-screen') {
            dash.classList.add('expanded');
            document.getElementById('evac-summary').style.display = 'block';
        } else {
            dash.classList.remove('expanded');
            document.getElementById('evac-summary').style.display = 'none';
        }
    }

    function initiateTriage(tool) {
        currentTool = tool;
        stepHistory = [];
        
        const badge = document.getElementById('mode-indicator');
        badge.innerText = tool;
        badge.style.display = 'inline-block';
        badge.style.backgroundColor = tool === 'MITT' ? '#E87722' : '#007F3B'; 
        
        if (pendingReTriageId) {
            currentPatientId = pendingReTriageId;
            pendingReTriageId = null;
            startFlow();
            return;
        }

        if (idMode === 'MANUAL') {
            document.getElementById('manual-id-input').value = "";
            document.getElementById('manual-id-modal').style.display = 'flex';
            document.getElementById('manual-id-input').focus();
        } else {
            const prefix = devicePrefix ? `${devicePrefix}-${tool}` : tool;
            currentPatientId = `${prefix}-${pad(patientCounter, 3)}`;
            startFlow();
        }
    }

    function submitManualId() {
        const val = document.getElementById('manual-id-input').value.trim();
        if(val) {
            currentPatientId = val;
            document.getElementById('manual-id-modal').style.display = 'none';
            const parts = val.split(/[-_ ]/);
            const lastPart = parts[parts.length-1];
            const potentialNum = parseInt(lastPart);
            if (!isNaN(potentialNum) && potentialNum >= patientCounter) {
                patientCounter = potentialNum + 1;
            }
            startFlow();
        } else {
            showToast("Please enter an ID");
        }
    }

    function closeManualId() {
        document.getElementById('manual-id-modal').style.display = 'none';
    }

    function startFlow() {
        document.getElementById('q-patient-id').innerText = currentPatientId;
        if (currentTool === 'TST') loadStep(tstFlow[0]);
        else loadStep(mittFlow[0]);
        showScreen('question-screen');
    }

    function loadStep(stepObj) {
        document.getElementById('question-screen').dataset.stepId = stepObj.id;
        document.getElementById('question-text').innerText = stepObj.question;
        const instructBox = document.getElementById('clinical-instruction-box');
        if (stepObj.instruction) {
            instructBox.style.display = 'block';
            instructBox.innerText = stepObj.instruction;
        } else { instructBox.style.display = 'none'; }
        
        document.getElementById('btn-back').style.display = (stepHistory.length > 0) ? 'block' : 'none';
    }

    function handleAnswer(answer) {
        try {
            triggerHaptic('tap');
            const stepId = document.getElementById('question-screen').dataset.stepId;
            stepHistory.push(stepId);
            
            const flow = currentTool === 'TST' ? tstFlow : mittFlow;
            const currentStepObj = flow.find(s => s.id === stepId);
            
            if (!currentStepObj) {
                console.error("Step not found: " + stepId);
                return;
            }

            const outcome = answer ? currentStepObj.yes : currentStepObj.no;

            if (outcome.type === 'next') {
                loadStep(flow.find(s => s.id === outcome.step));
            } else if (outcome.type === 'result') {
                triggerHaptic('success');
                logResult(outcome.category, outcome.action, outcome.reason);
            }
        } catch (err) {
            console.error(err);
            showToast("Error processing answer");
        }
    }
    
    function stepBack() {
        if (stepHistory.length === 0) return;
        const prevStepId = stepHistory.pop();
        const flow = currentTool === 'TST' ? tstFlow : mittFlow;
        loadStep(flow.find(s => s.id === prevStepId));
    }
    
    function confirmCancelCase() {
        if(confirm("Cancel current assessment? No data will be saved for this patient ID.")) {
            resetToHome();
        }
    }

    function logResult(category, action, reason) {
        try {
            const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const timestamp = getClinicalTimestamp();
            
            if (category === 'DEAD') {
                 document.getElementById('tod-modal').style.display = 'flex';
                 window.pendingDeadEntry = {category, action, reason, time, timestamp};
                 return; 
            }
            
            completeLogResult(category, action, reason, time, timestamp);
        } catch(e) {
            console.error(e);
            showToast("Error saving result");
        }
    }
    
    function confirmDeath() {
        const tod = document.getElementById('tod-input').value;
        if(!tod) { showToast("Enter Time of Death"); return; }
        
        const p = window.pendingDeadEntry;
        p.action += ` [TOD: ${tod}]`;
        completeLogResult(p.category, p.action, p.reason, p.time, p.timestamp);
        
        document.getElementById('tod-modal').style.display = 'none';
    }
    
    function closeTodModal() {
        document.getElementById('tod-modal').style.display = 'none';
    }

    function completeLogResult(category, action, reason, time, timestamp) {
        const entry = {
                id: currentPatientId, 
                time: time, 
                timestamp: timestamp, 
                tool: currentTool, 
                category: category, 
                action: action,
                reason: reason,
                triager: triagerName,
                location: currentPosition, 
                sector: currentSector, 
                demos: "", 
                allergies: "", 
                notes: "", 
                highRisk: false, 
                interventions: {}, 
                evacuated: false, 
                evacDest: "",
                evacVehicle: ""
        };

        incidentLog.push(entry);
        currentLogIndex = incidentLog.length - 1; 
        
        logAudit("TRIAGE_COMPLETE", entry.id, `Category: ${category}, Reason: ${reason}`, timestamp);
        
        saveState();
        updateDashboard();
        renderResultScreen(entry);
    }
    
    function reTriage() {
        if (currentLogIndex === -1) return;
        const entry = incidentLog[currentLogIndex];
        pendingReTriageId = entry.id;
        
        logAudit("RETRIAGE_STARTED", entry.id, `Re-triage from ${entry.tool}. Prev Cat: ${entry.category}`, getClinicalTimestamp());
        showScreen('home-screen');
        showToast(`Re-Triaging ${entry.id}. Select Tool.`);
    }
    
    function renderResultScreen(entry) {
        document.getElementById('r-patient-id').innerText = entry.id;
        const tag = document.getElementById('result-tag');
        document.getElementById('tag-text').innerText = entry.category;
        
        let labelText = "";
        if (entry.category === 'P1') labelText = "IMMEDIATE";
        else if (entry.category === 'P2') labelText = "URGENT";
        else if (entry.category === 'P3') labelText = "DELAYED";
        else labelText = "EXPECTANT";
        document.getElementById('tag-label').innerText = labelText;
        
        tag.className = 'triage-tag'; 
        if (entry.category === 'P1') tag.classList.add('p1');
        else if (entry.category === 'P2') tag.classList.add('p2');
        else if (entry.category === 'P3') tag.classList.add('p3');
        else tag.classList.add('dead');

        document.getElementById('hr-badge').style.display = entry.highRisk ? 'block' : 'none';
        document.getElementById('action-box').innerText = entry.action;
        
        const promptBox = document.getElementById('clinical-prompts');
        const reasonKey = entry.reason;
        
        let prompts = clinicalPrompts[reasonKey];
        if (!prompts && reasonKey === "Penetrating Trauma") prompts = clinicalPrompts["Penetrating Trauma"];
        if (!prompts && reasonKey === "Age < 2") prompts = clinicalPrompts["Age < 2"];
        
        if (prompts) {
            promptBox.style.display = 'block';
            promptBox.innerHTML = `<h4>Clinical Considerations</h4><ul>${prompts.map(p => `<li>${p}</li>`).join('')}</ul>`;
        } else {
            promptBox.style.display = 'none';
        }
        
        const locText = document.getElementById('location-status-text');
        let displayLoc = currentSector ? `Sec: ${currentSector}` : "";
        if(currentPosition) {
            displayLoc += (displayLoc ? " | " : "") + `${currentPosition.lat}, ${currentPosition.lng}`;
            locText.style.color = "var(--nhs-green)";
        } else {
            if(!displayLoc) { displayLoc = "No GPS / Sector"; locText.style.color = "var(--nhs-red)"; }
            else { locText.style.color = "var(--nhs-blue)"; }
        }
        locText.innerHTML = displayLoc;
        
        document.getElementById('p-cat-override').value = entry.category;
        document.getElementById('p-demos').value = entry.demos;
        document.getElementById('p-allergies').value = entry.allergies;
        document.getElementById('p-notes').value = entry.notes;
        document.getElementById('p-sector').value = entry.sector;
        document.getElementById('risk-check').checked = entry.highRisk;
        document.getElementById('p-evac-vehicle').value = entry.evacVehicle || "";
        document.getElementById('p-evac-dest').value = entry.evacDest || "";
        
        const evacBtn = document.getElementById('btn-evac');
        if(entry.evacuated) {
            evacBtn.innerText = "Mark as ON SCENE (Undo Evac)";
            evacBtn.style.backgroundColor = "#555";
        } else {
            evacBtn.innerText = "Mark as EVACUATED";
            evacBtn.style.backgroundColor = "var(--nhs-dark-blue)";
        }
        
        document.querySelectorAll('.int-btn').forEach(btn => {
             btn.classList.remove('active');
             btn.querySelector('.int-time').innerText = "";
        });
        
        const intButtons = document.querySelectorAll('.int-btn');
        intButtons.forEach(btn => {
             const type = btn.getAttribute('data-type');
             if(entry.interventions && entry.interventions[type]) {
                 btn.classList.add('active');
                 btn.querySelector('.int-time').innerText = entry.interventions[type].time;
             }
        });

        document.getElementById('details-container').classList.remove('show');
        document.getElementById('btn-toggle-details').innerText = "+ Interventions & Notes";

        showScreen('result-screen');
    }

    function toggleDetails() {
        const container = document.getElementById('details-container');
        const btn = document.getElementById('btn-toggle-details');
        if(container.classList.contains('show')) {
            container.classList.remove('show');
            btn.innerText = "+ Interventions & Notes";
        } else {
            container.classList.add('show');
            btn.innerText = "Hide Details";
            container.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function generateAtmist() {
        if(currentLogIndex === -1) return;
        const entry = incidentLog[currentLogIndex];
        
        let treatments = "None";
        if (entry.interventions && Object.keys(entry.interventions).length > 0) {
            treatments = Object.keys(entry.interventions).join(", ");
        }

        const html = `
            <div class="atmist-row"><div class="atmist-label">A</div><div class="atmist-val">${entry.demos || "Unknown"}</div></div>
            <div class="atmist-row"><div class="atmist-label">T</div><div class="atmist-val">${entry.time}</div></div>
            <div class="atmist-row"><div class="atmist-label">M</div><div class="atmist-val">${entry.notes || "Not specified"}</div></div>
            <div class="atmist-row"><div class="atmist-label">I</div><div class="atmist-val">See Body Map / Notes</div></div>
            <div class="atmist-row"><div class="atmist-label">S</div><div class="atmist-val"><strong>${entry.category}</strong> (${entry.reason})</div></div>
            <div class="atmist-row"><div class="atmist-label">T</div><div class="atmist-val">${treatments}</div></div>
        `;
        document.getElementById('atmist-content').innerHTML = html;
        document.getElementById('atmist-modal').style.display = 'flex';
    }
    function closeAtmist() { document.getElementById('atmist-modal').style.display = 'none'; }
    
    function recordIntervention(btn, type) {
        if(currentLogIndex === -1) return;
        
        triggerHaptic('tap');
        const entry = incidentLog[currentLogIndex];
        const timeStr = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const ts = getClinicalTimestamp();
        
        if(!entry.interventions) entry.interventions = {};
        
        if(entry.interventions[type]) {
            delete entry.interventions[type];
            btn.classList.remove('active');
            btn.querySelector('.int-time').innerText = "";
            logAudit("INTERVENTION_REMOVED", entry.id, type, ts);
        } else {
            entry.interventions[type] = { time: timeStr, ts: ts };
            btn.classList.add('active');
            btn.querySelector('.int-time').innerText = timeStr;
            logAudit("INTERVENTION_ADDED", entry.id, type, ts);
        }
        saveState();
    }
    
    function toggleEvac() {
        if(currentLogIndex === -1) return;
        const entry = incidentLog[currentLogIndex];
        const ts = getClinicalTimestamp();
        entry.evacuated = !entry.evacuated;
        entry.evacVehicle = document.getElementById('p-evac-vehicle').value;
        entry.evacDest = document.getElementById('p-evac-dest').value;
        
        logAudit(entry.evacuated ? "EVACUATION" : "EVACUATION_UNDO", entry.id, `Vehicle: ${entry.evacVehicle}, Dest: ${entry.evacDest}`, ts);
        saveState();
        updateDashboard();
        renderResultScreen(entry); 
    }

    function openBodyMap() {
        document.getElementById('body-map-modal').style.display = 'flex';
    }
    function closeBodyMap() {
        document.getElementById('body-map-modal').style.display = 'none';
    }
    function handleBodyMapClick(evt) {
        if(currentLogIndex === -1) return;
        const svg = document.getElementById('bodymap');
        const pt = svg.createSVGPoint();
        pt.x = evt.clientX; pt.y = evt.clientY;
        const cursorPt = pt.matrixTransform(svg.getScreenCTM().inverse());
        
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", cursorPt.x - 5);
        text.setAttribute("y", cursorPt.y + 5);
        text.setAttribute("fill", "red");
        text.setAttribute("font-size", "24");
        text.setAttribute("font-weight", "bold");
        text.textContent = "X";
        svg.appendChild(text);
        
        let loc = "Body";
        if(cursorPt.y < 80) loc = "Head/Neck";
        else if(cursorPt.y > 200) loc = "Legs";
        else loc = "Torso/Arms";
        
        const noteField = document.getElementById('p-notes');
        const timestamp = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const noteText = ` [Injury marked on ${loc} @ ${timestamp}]`;
        noteField.value += noteText;
        
        logAudit("BODYMAP_MARK", incidentLog[currentLogIndex].id, loc, getClinicalTimestamp());
        autoSave();
    }

    function startVoice(fieldId) {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("Voice not supported on this browser."); return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = "en-GB";
        recognition.onresult = function(event) {
            document.getElementById(fieldId).value += " " + event.results[0][0].transcript;
            autoSave('Voice Note Added');
        };
        recognition.onerror = function(event) {
            console.error(event.error);
            showToast("Voice Error: " + event.error);
        };
        recognition.start();
    }

    function scanPatientQR() {
        scanMode = 'PATIENT';
        startScanner();
    }

    function scanHandover() {
        scanMode = 'HANDOVER';
        startScanner();
    }
    
    function generatePatientQR() {
        if(currentLogIndex === -1) return;
        const entry = incidentLog[currentLogIndex];
        
        const compressedEntry = {
            id: entry.id,
            time: entry.time,
            timestamp: entry.timestamp,
            tool: entry.tool,
            category: entry.category,
            action: entry.action,
            reason: entry.reason,
            triager: entry.triager,
            location: entry.location,
            sector: entry.sector,
            demos: entry.demos,
            allergies: entry.allergies,
            notes: entry.notes,
            highRisk: entry.highRisk,
            interventions: entry.interventions,
            evacuated: entry.evacuated,
            evacDest: entry.evacDest,
            evacVehicle: entry.evacVehicle
        };

        const transferObj = { type: "MIT_FULL_PATIENT", data: compressedEntry };
        const jsonStr = JSON.stringify(transferObj);
        
        document.getElementById('qrcode').innerHTML = "";
        
        try {
            new QRCode(document.getElementById("qrcode"), {
                text: jsonStr, width: 256, height: 256,
                correctLevel : QRCode.CorrectLevel.L
            });
            document.getElementById('qr-title').innerText = "Patient Data";
            document.getElementById('qr-desc').innerText = "Scan to transfer data";
            document.getElementById('qr-modal').style.display = 'flex';
        } catch(e) {
            showToast("Data too large for QR");
        }
    }

    function generateMyIdentityQR() {
        const data = `MIT_USER|${triagerName}|${userRole}`;
        
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: data, width: 200, height: 200
        });
        document.getElementById('qr-title').innerText = "My ID";
        document.getElementById('qr-desc').innerText = "Show to a colleague for handover";
        document.getElementById('qr-modal').style.display = 'flex';
    }

    function closeQR() { document.getElementById('qr-modal').style.display = 'none'; }

    function startScanner() {
        document.getElementById('scanner-modal').style.display = 'flex';
        
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().then(() => {
                initScannerInstance();
            }).catch(err => {
                console.warn("Clear failed", err);
                initScannerInstance(); 
            });
        } else {
            initScannerInstance();
        }
    }

    function initScannerInstance() {
        html5QrcodeScanner = new Html5Qrcode("scanner-reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            console.error(err);
            showToast("Camera error: " + err);
            document.getElementById('scanner-modal').style.display = 'none';
        });
    }

    function stopScanner() {
        if(html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                document.getElementById('scanner-modal').style.display = 'none';
            }).catch(err => {
                console.error("Stop failed", err);
                document.getElementById('scanner-modal').style.display = 'none';
            });
        } else {
            document.getElementById('scanner-modal').style.display = 'none';
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        stopScanner();
        playBeep();
        triggerHaptic('success');
        
        if (decodedText.startsWith("MIT_USER")) {
            handleIdentityScan(decodedText);
        } else {
            try {
                const jsonObj = JSON.parse(decodedText);
                if (jsonObj.type === "MIT_FULL_PATIENT") {
                    handleFullPatientImport(jsonObj.data);
                    return;
                }
            } catch(e) {
                if (decodedText.startsWith("MIT_PT") || decodedText.includes('|')) {
                     handleLegacyPatientScan(decodedText);
                     return;
                }
            }
            showToast("Unknown QR Format");
        }
    }

    function handleIdentityScan(text) {
        const parts = text.split('|');
        const colleagueName = parts[1] || "Unknown";
        
        if (currentLogIndex > -1) {
             const entry = incidentLog[currentLogIndex];
             entry.notes += ` [Handed over to ${colleagueName}]`;
             entry.evacuated = true; 
             entry.evacVehicle = `Handover: ${colleagueName}`;
             logAudit("HANDOVER_OUT", entry.id, `To ${colleagueName}`, Date.now());
             saveState();
             showToast(`Logged handover to ${colleagueName}`);
        }
    }

    function handleFullPatientImport(data) {
        const newId = data.id;
        const originTriager = data.triager;
        const existingIndex = incidentLog.findIndex(e => e.id === newId);
        
        if(existingIndex > -1) {
            if(confirm(`Patient ${newId} already exists. Update record with handover data?`)) {
                const entry = incidentLog[existingIndex];
                Object.assign(entry, data);
                entry.notes += ` [Imported Update from ${originTriager}]`;
                
                logAudit("DATA_IMPORT_UPDATE", newId, `Full JSON from ${originTriager}`, Date.now());
                saveState();
                showToast("Record Updated");
            }
        } else {
            const entry = { ...data };
            entry.notes += ` [Origin: ${originTriager}]`;
            
            incidentLog.push(entry);
            logAudit("DATA_IMPORT_NEW", newId, `Full JSON from ${originTriager}`, Date.now());
            saveState();
            updateDashboard();
            showToast(`Imported ${newId}`);
        }
    }

    function handleLegacyPatientScan(text) {
        let parts = text.split('|');
        if(text.startsWith("MIT_PT|")) {
             parts = text.substring(7).split('|');
        }
        
        if(parts.length < 3) { showToast("Invalid Patient QR"); return; }
        
        const newId = parts[0];
        const category = parts[1];
        const notes = parts[5] || "";
        const originTriager = parts[6] || "Unknown";

        const entry = {
                id: newId,
                time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                tool: "IMPORT",
                category: category,
                action: "LEGACY IMPORT",
                reason: "Scan Import",
                triager: triagerName, 
                location: currentPosition,
                sector: currentSector,
                demos: parts[3] || "",
                allergies: parts[4] || "",
                notes: `${notes} [Origin: ${originTriager}]`,
                highRisk: false,
                interventions: {},
                evacuated: false,
                evacDest: "",
                evacVehicle: ""
        };
        incidentLog.push(entry);
        logAudit("DATA_IMPORT_LEGACY", newId, `From ${originTriager}`, Date.now());
        saveState();
        updateDashboard();
        showToast(`Imported ${newId}`);
    }

    function onScanFailure(error) { }

    function autoSave(reason = 'Manual Edit') {
        if(currentLogIndex > -1) {
            const entry = incidentLog[currentLogIndex];
            const oldCat = entry.category;
            
            entry.category = document.getElementById('p-cat-override').value; 
            entry.demos = document.getElementById('p-demos').value;
            entry.allergies = document.getElementById('p-allergies').value;
            entry.notes = document.getElementById('p-notes').value;
            entry.highRisk = document.getElementById('risk-check').checked;
            entry.evacVehicle = document.getElementById('p-evac-vehicle').value;
            entry.evacDest = document.getElementById('p-evac-dest').value;
            entry.sector = document.getElementById('p-sector').value;
            
            const tag = document.getElementById('result-tag');
            document.getElementById('tag-text').innerText = entry.category;
            
            let labelText = "";
            if (entry.category === 'P1') labelText = "IMMEDIATE";
            else if (entry.category === 'P2') labelText = "URGENT";
            else if (entry.category === 'P3') labelText = "DELAYED";
            else labelText = "EXPECTANT";
            document.getElementById('tag-label').innerText = labelText;

            tag.className = 'triage-tag'; 
            if (entry.category === 'P1') tag.classList.add('p1');
            else if (entry.category === 'P2') tag.classList.add('p2');
            else if (entry.category === 'P3') tag.classList.add('p3');
            else tag.classList.add('dead');
            
            document.getElementById('hr-badge').style.display = entry.highRisk ? 'block' : 'none';
            
            if(oldCat !== entry.category) {
                logAudit("CATEGORY_CHANGE", entry.id, `Changed ${oldCat} -> ${entry.category}`, getClinicalTimestamp());
            }
            
            saveState();
            updateDashboard();
        }
    }
    
    function editEntry(index) {
        currentLogIndex = index;
        renderResultScreen(incidentLog[index]);
        toggleDetails();
    }

    function showMethane() { showScreen('methane-screen'); }
    function showMethaneHistory() {
        const list = document.getElementById('methane-history-list');
        list.innerHTML = "";
        methaneHistory.forEach((m, i) => {
            const div = document.createElement('div');
            div.style.borderBottom = "1px solid #ccc";
            div.style.padding = "10px";
            div.innerHTML = `<strong>Version ${i+1}</strong> (${new Date(m.timestamp).toLocaleTimeString()})<br>
            Cas: ${m.n} | Haz: ${m.h}`;
            list.appendChild(div);
        });
        showScreen('methane-history-screen');
    }
    
    function autoFillCasualties() {
        let p1=0, p2=0, p3=0, dead=0;
        const unique = {};
        incidentLog.forEach(e => {
            if (!unique[e.id] || unique[e.id].timestamp < e.timestamp) {
                unique[e.id] = e;
            }
        });
        Object.values(unique).forEach(e => {
             if(e.category === 'P1') p1++;
            else if(e.category === 'P2') p2++;
            else if(e.category === 'P3') p3++;
            else dead++;
        });
        const summary = `Total: ${Object.keys(unique).length} (P1:${p1}, P2:${p2}, P3:${p3}, Dead:${dead})`;
        document.getElementById('m-num').value = summary;
    }
    
    function saveMethane() { 
        const mData = {
            m: document.getElementById('m-decl').value,
            e: document.getElementById('m-loc').value,
            t: document.getElementById('m-type').value,
            h: document.getElementById('m-haz').value,
            a: document.getElementById('m-acc').value,
            n: document.getElementById('m-num').value,
            e_svc: document.getElementById('m-svc').value,
            timestamp: Date.now()
        };
        methaneHistory.push(mData);
        saveState(); 
        showToast("Report Saved"); 
        showScreen('home-screen'); 
    }

    function nextPatient() {
        window.pendingReTriageId = null;
        if(idMode === 'AUTO') {
            patientCounter++;
            saveState();
        }
        initiateTriage(currentTool); 
    }

    function resetToHome() { showScreen('home-screen'); }

    function updateDashboard() {
        let p1=0, p2=0, p3=0, dead=0, evac=0;
        let totP1=0, totP2=0, totP3=0, totDead=0;
        
        const unique = {};
        incidentLog.forEach(e => {
            if (!unique[e.id] || unique[e.id].timestamp < e.timestamp) {
                unique[e.id] = e;
            }
        });
        
        Object.values(unique).forEach(e => {
            if(e.category === 'P1') totP1++;
            else if(e.category === 'P2') totP2++;
            else if(e.category === 'P3') totP3++;
            else totDead++;

            if(e.evacuated) {
                evac++;
            } else {
                if(e.category === 'P1') p1++;
                else if(e.category === 'P2') p2++;
                else if(e.category === 'P3') p3++;
                else dead++;
            }
        });
        
        document.getElementById('count-p1').innerText = `${p1} / ${totP1}`;
        document.getElementById('count-p2').innerText = `${p2} / ${totP2}`;
        document.getElementById('count-p3').innerText = `${p3} / ${totP3}`;
        document.getElementById('count-dead').innerText = `${dead} / ${totDead}`;
        
        document.getElementById('evac-summary').innerText = `Evacuated: ${evac} | On Scene: ${Object.keys(unique).length - evac}`;
    }

    function showLog() {
        const tbody = document.getElementById('log-body');
        tbody.innerHTML = '';
        
        const unique = {};
        incidentLog.forEach((e, i) => {
             if (!unique[e.id] || unique[e.id].timestamp < e.timestamp) {
                unique[e.id] = {...e, originalIndex: i};
            }
        });
        
        const sorted = Object.values(unique).sort((a,b) => b.timestamp - a.timestamp);
        const now = Date.now();
        
        sorted.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "clickable-row";
            
            if(row.interventions && row.interventions['Tourniquet']) {
               const tqTime = row.interventions['Tourniquet'].ts;
               if (tqTime && (now - tqTime > 7200000)) {
                   tr.classList.add('critical-alert');
               }
            }
            
            tr.onclick = function() { editEntry(row.originalIndex); }; 
            
            let catStyle = '';
            if(row.category === 'P1') catStyle = 'background-color:var(--nhs-red); color:white; font-weight:bold;';
            if(row.category === 'P2') catStyle = 'background-color:var(--nhs-yellow);';
            if(row.category === 'P3') catStyle = 'background-color:var(--nhs-green); color:white;';
            if(row.category === 'DEAD') catStyle = 'background-color:#333; color:white;';

            let locText = "";
            if(row.sector) locText += `[${row.sector}] `;
            if(row.location) locText += `${row.location.lat}, ${row.location.lng}`;
            if(!locText) locText = "-";

            let details = "";
            if(row.demos) details += `[${row.demos}] `;
            if(row.allergies) details += `Allergies: ${row.allergies}. `;
            if(row.notes) details += `${row.notes} `;
            if(row.evacuated) details += `<strong>[EVACUATED ${row.evacVehicle}]</strong> `;
            
            if(row.interventions) {
                const ints = Object.entries(row.interventions).map(([k, v]) => `${k}@${v.time}`);
                if(ints.length > 0) details += `<strong>[${ints.join(', ')}]</strong> `;
            }
            
            if(row.highRisk) details = `<span style="color:red; font-weight:bold;">[HIGH RISK]</span> ` + details;

            tr.innerHTML = `
                <td>${row.time}</td>
                <td><strong>${row.id}</strong></td>
                <td>${row.triager || "-"}</td>
                <td style="${catStyle}">${row.category}</td>
                <td><small>${row.reason || "-"}</small></td>
                <td style="font-size:0.75rem;">${locText}</td>
                <td style="font-size:0.8rem;">${details}</td>
            `;
            tbody.appendChild(tr);
        });
        showScreen('log-screen');
    }

    function showMap() {
        showScreen('map-screen');
        if (!patientMap) {
            patientMap = L.map('patient-map').setView([54.0, -2.0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(patientMap);
        }

        mapMarkers.forEach(m => patientMap.removeLayer(m));
        mapMarkers = [];

        const unique = {};
        incidentLog.forEach(e => {
            if (!unique[e.id] || unique[e.id].timestamp < e.timestamp) {
                unique[e.id] = e;
            }
        });

        let bounds = [];

        Object.values(unique).forEach(patient => {
            if (patient.location && patient.location.lat && patient.location.lng) {
                const lat = parseFloat(patient.location.lat);
                const lng = parseFloat(patient.location.lng);
                
                let markerColor = 'blue';
                if (patient.category === 'P1') markerColor = 'red';
                if (patient.category === 'P2') markerColor = 'yellow';
                if (patient.category === 'P3') markerColor = 'green';
                if (patient.category === 'DEAD') markerColor = 'black';

                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: markerColor,
                    color: "#fff",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(patientMap);

                marker.bindPopup(`<b>${patient.id}</b><br>Category: ${patient.category}<br>${patient.notes || ''}`);
                mapMarkers.push(marker);
                bounds.push([lat, lng]);
            }
        });

        if (bounds.length > 0) {
            patientMap.fitBounds(bounds, { padding: [50, 50] });
        } else if (currentPosition) {
            patientMap.setView([currentPosition.lat, currentPosition.lng], 15);
        }

        setTimeout(() => { if (patientMap) patientMap.invalidateSize(); }, 300);
    }

    function escapeCSV(str) {
        if (!str) return "";
        return `"${str.toString().replace(/"/g, '""')}"`;
    }

    function downloadCSV(type) {
        let csv = "";
        
        if (type === 'SNAPSHOT') {
            const m = JSON.parse(localStorage.getItem('mit_methane') || "{}");
            if(m.m) {
                csv += `METHANE REPORT (Latest)\n`;
                csv += `M,${escapeCSV(m.m)}\nE,${escapeCSV(m.e)}\nT,${escapeCSV(m.t)}\nH,${escapeCSV(m.h)}\nA,${escapeCSV(m.a)}\nN,${escapeCSV(m.n)}\nE,${escapeCSV(m.e_svc)}\n\n`;
            }
            csv += "LogID,Date,Time,Tool,Triager,Sector,Lat,Lng,GPS_Accuracy,Category,Reason,Action,Age_Gender,Allergies,Clinical_Notes,Interventions,High_Risk_Flag,Evacuation_Status,Dest,Vehicle\n";
            
            const unique = {};
            incidentLog.forEach(e => {
                if (!unique[e.id] || unique[e.id].timestamp < e.timestamp) {
                    unique[e.id] = e;
                }
            });
            
            Object.values(unique).forEach(r => {
                const dateStr = new Date(r.timestamp).toLocaleDateString();
                const lat = r.location ? r.location.lat : "";
                const lng = r.location ? r.location.lng : "";
                const acc = r.location ? r.location.acc : "";
                const sec = r.sector || "";
                
                let intStr = "";
                if(r.interventions) {
                    intStr = Object.entries(r.interventions).map(([k,v]) => `${k}(${v.time})`).join("; ");
                }
                
                const highRiskStr = r.highRisk ? "YES" : "NO";
                const evacStr = r.evacuated ? "EVACUATED" : "ON SCENE";

                csv += `${escapeCSV(r.id)},${escapeCSV(dateStr)},${escapeCSV(r.time)},${escapeCSV(r.tool)},${escapeCSV(r.triager)},${escapeCSV(sec)},${lat},${lng},${acc},${escapeCSV(r.category)},${escapeCSV(r.reason)},${escapeCSV(r.action)},${escapeCSV(r.demos)},${escapeCSV(r.allergies)},${escapeCSV(r.notes)},${escapeCSV(intStr)},${highRiskStr},${evacStr},${escapeCSV(r.evacDest)},${escapeCSV(r.evacVehicle)}\n`;
            });
        } else {
            csv += "System_Time,Clinical_Time,User,Action_Type,Patient_ID,Details,Sector,Lat,Lng\n";
            auditLog.forEach(a => {
                const sysDate = new Date(a.sysTime).toLocaleString();
                const clinDate = new Date(a.clinTime).toLocaleString();
                const lat = a.gps ? a.gps.lat : "";
                const lng = a.gps ? a.gps.lng : "";
                
                csv += `${escapeCSV(sysDate)},${escapeCSV(clinDate)},${escapeCSV(a.user)},${escapeCSV(a.action)},${escapeCSV(a.patientId)},${escapeCSV(a.details)},${escapeCSV(a.sector)},${lat},${lng}\n`;
            });
        }
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `incident_${type}_${new Date().getTime()}.csv`;
        a.click();
        showToast("CSV Downloaded");
    }

    function pad(num, size) {
        num = num.toString();
        while (num.length < size) num = "0" + num;
        return num;
    }
</script>
</body>
</html>
