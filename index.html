<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Major Incident Triage</title>
<style>
    :root {
        --nhs-blue: #005EB8;
        --nhs-dark-blue: #003087;
        --nhs-green: #007F3B;
        --nhs-red: #DA291C;
        --nhs-yellow: #FAE100;
        --nhs-grey: #4C6272;
        --nhs-pale-grey: #E8EDEE;
        --white: #FFFFFF;
        --black: #212b32;
        --text-color: #212b32;
        --bg-color: #E8EDEE;
        --card-bg: #FFFFFF;
        --toast-bg: #333;
    }

    /* Night Mode Variables */
    body.night-mode {
        --nhs-blue: #005EB8;
        --nhs-dark-blue: #000000;
        --nhs-pale-grey: #121212;
        --white: #000000;
        --black: #FFFFFF;
        --text-color: #f0f0f0;
        --bg-color: #000000;
        --card-bg: #1e1e1e;
        --toast-bg: #555;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        -webkit-font-smoothing: antialiased;
        overscroll-behavior-y: none;
    }

    /* Layout */
    .container {
        max-width: 800px;
        margin: 0 auto;
        min-height: 100vh;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        background-color: var(--card-bg);
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        transition: background-color 0.3s, color 0.3s;
    }

    header {
        background-color: var(--nhs-blue);
        color: white;
        padding: 0.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        gap: 10px;
    }

    h1 { margin: 0; font-size: 1.1rem; font-weight: bold; white-space: nowrap; }
    
    .status-bar {
        background-color: var(--nhs-dark-blue);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .gps-status {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(255,255,255,0.2);
    }
    .gps-active { color: #ccffcc; border: 1px solid #ccffcc; }
    .gps-inactive { color: #ffcccc; border: 1px solid #ffcccc; }

    main {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch;
    }

    /* Buttons */
    .btn {
        display: block;
        width: 100%;
        padding: 1rem;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        font-weight: bold;
        text-align: center;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        color: white;
        touch-action: manipulation;
    }

    .btn:active { opacity: 0.8; transform: scale(0.99); }

    .btn-primary { background-color: var(--nhs-blue); }
    .btn-yes { background-color: var(--nhs-green); font-size: 1.5rem; height: 80px; }
    .btn-no { background-color: var(--nhs-red); font-size: 1.5rem; height: 80px; }
    .btn-secondary { background-color: var(--nhs-grey); }
    .btn-danger { background-color: var(--nhs-red); }

    /* Header Controls */
    .header-controls { display: flex; gap: 8px; }

    .icon-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.4);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        font-weight: bold;
    }

    /* Blackout Curtain */
    #blackout-curtain {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: black;
        z-index: 9999;
        display: none;
        color: #333;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        user-select: none;
    }
    #blackout-curtain.active { display: flex; }

    /* Dashboard */
    .dashboard {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 1rem;
    }
    .dash-card {
        padding: 10px 5px;
        text-align: center;
        border-radius: 6px;
        color: black;
        font-weight: bold;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .dash-p1 { background: var(--nhs-red); color: white; }
    .dash-p2 { background: var(--nhs-yellow); }
    .dash-p3 { background: var(--nhs-green); color: white; }
    .dash-dead { background: #333; color: white; }
    .dash-num { font-size: 1.4rem; display: block; }
    .dash-label { font-size: 0.75rem; }

    /* Mode Badge */
    .mode-badge {
        display: inline-block;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(0,0,0,0.3);
        margin-left: 5px;
        vertical-align: middle;
    }

    /* Inputs */
    .input-group { margin-bottom: 1rem; }
    .input-group label { display: block; font-weight: bold; margin-bottom: 0.4rem; color: var(--nhs-blue); }
    body.night-mode .input-group label { color: var(--nhs-yellow); }
    
    .input-group input, .input-group textarea, .input-group select {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px; 
        font-family: inherit;
        background: var(--card-bg);
        color: var(--text-color);
        -webkit-appearance: none;
    }
    
    /* Screens */
    .screen { display: none; height: 100%; flex-direction: column; }
    .screen.active { display: flex; }

    /* Cards */
    .instruction-card {
        background: var(--card-bg);
        border: 1px solid #ccc;
        border-left: 6px solid var(--nhs-blue);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        font-size: 1.4rem;
        font-weight: bold;
        line-height: 1.3;
        color: var(--text-color);
        border-radius: 4px;
    }

    .clinical-note {
        font-size: 1rem;
        color: #333;
        background: #fff9e6;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        border: 1px solid #e0c880;
    }
    body.night-mode .clinical-note {
        background: #332b00;
        color: #fff;
        border-color: #665500;
    }

    /* Results */
    .triage-tag {
        font-size: 4rem;
        font-weight: bold;
        text-align: center;
        padding: 2rem;
        margin: 1rem 0;
        border-radius: 12px;
        border: 4px solid #000;
        position: relative;
        background: var(--card-bg);
        color: var(--text-color);
    }
    body.night-mode .triage-tag { border-color: #fff; }

    .hr-badge {
        position: absolute;
        top: -12px;
        right: -10px;
        background: var(--nhs-red);
        color: white;
        font-size: 0.9rem;
        padding: 6px 12px;
        border-radius: 20px;
        border: 2px solid white;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .p1 { background-color: var(--nhs-red) !important; color: white !important; }
    .p2 { background-color: var(--nhs-yellow) !important; color: black !important; }
    .p3 { background-color: var(--nhs-green) !important; color: white !important; }
    .dead { background-color: #fff !important; color: black !important; border-color: black !important; }

    /* Log Table */
    .log-container { overflow-x: auto; margin-bottom: 1rem; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { border: 1px solid #666; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #ddd; color: black; font-weight: bold; }
    body.night-mode th { background-color: #333; color: white; }
    
    /* Edit Indicator */
    tr.clickable-row { cursor: pointer; }
    tr.clickable-row:hover { background-color: rgba(0,0,0,0.05); }
    body.night-mode tr.clickable-row:hover { background-color: rgba(255,255,255,0.1); }

    /* Toast Notification */
    #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: var(--toast-bg);
        color: #fff;
        text-align: center;
        border-radius: 50px;
        padding: 16px;
        position: fixed;
        z-index: 1000;
        left: 50%;
        top: 30px;
        transform: translateX(-50%);
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        opacity: 0;
        transition: opacity 0.3s, top 0.3s;
    }
    #toast.show { visibility: visible; opacity: 1; top: 50px; }

    /* Print Styles */
    @media print {
        header, .btn, .status-bar, .instruction-card, .input-group, .header-controls, #toast { display: none !important; }
        .screen { display: none !important; }
        #log-screen { display: block !important; }
        .log-container { overflow: visible; }
        body, .container { background: white; color: black; box-shadow: none; width: 100%; max-width: 100%; min-height: auto; }
        table { font-size: 10pt; width: 100%; border: 1px solid black; }
        th, td { border: 1px solid black; }
        h2 { display: block; }
        a { text-decoration: none; color: black; }
    }
</style>
</head>
<body>

<div id="toast">Notification</div>
<div id="blackout-curtain" onclick="toggleBlackout()"></div>

<div class="container">
    <header>
        <div>
            <h1>Major Incident <span id="mode-indicator" class="mode-badge" style="display:none;"></span></h1>
        </div>
        <div class="header-controls">
            <button class="icon-btn" onclick="toggleBlackout()">Blackout</button>
            <button class="icon-btn" onclick="toggleNightMode()">&#9790;</button>
        </div>
    </header>

    <div class="status-bar">
        <span id="header-callsign">Device: -</span>
        <span id="gps-indicator" class="gps-status gps-inactive">GPS: Searching...</span>
    </div>

    <main>
        
        <!-- INTRO SCREEN -->
        <div id="intro-screen" class="screen active">
            <h2>Configuration</h2>
            <div class="input-group">
                <label>Device Call Sign (Recommended)</label>
                <input type="text" id="intro-callsign" placeholder="e.g. ALPHA-1" autocomplete="off">
            </div>

            <p><strong>Select Role:</strong></p>

            <button class="btn btn-primary" style="padding: 1.2rem;" onclick="setUserRole('HCP')">
                Healthcare Professional<br>
                <span style="font-size:0.9rem; font-weight:normal;">Doctor, Nurse, Paramedic</span>
            </button>

            <button class="btn btn-secondary" style="padding: 1.2rem;" onclick="setUserRole('NON_HCP')">
                Non-Clinical / First Aid<br>
                <span style="font-size:0.9rem; font-weight:normal;">Police, Fire, First Responder</span>
            </button>
        </div>

        <!-- HOME SCREEN -->
        <div id="home-screen" class="screen">
            <div style="text-align:center; margin-bottom: 1.5rem;">
                <p>Select Action:</p>
            </div>
            
            <button class="btn btn-primary" onclick="initiateTriage('TST')">
                Ten Second Triage (TST)<br>
                <span style="font-size:0.9rem; font-weight:normal;">Rapid Primary Triage</span>
            </button>
            
            <button id="btn-mitt" class="btn btn-primary" onclick="initiateTriage('MITT')">
                Major Incident Triage Tool (MITT)<br>
                <span style="font-size:0.9rem; font-weight:normal;">Secondary Clinical Triage</span>
            </button>

            <button class="btn btn-secondary" onclick="showMethane()">
                METHANE Report<br>
                <span style="font-size:0.9rem; font-weight:normal;">Major Incident Declaration</span>
            </button>

            <div style="margin-top: auto;">
                <button class="btn btn-secondary" onclick="showLog()">View Log & Dashboard</button>
                <button class="btn btn-secondary" style="background-color: #333;" onclick="resetApp()">Change Role / ID</button>
            </div>
        </div>

        <!-- TRIAGE QUESTION SCREEN -->
        <div id="question-screen" class="screen">
            <h2 id="question-header">Assessment</h2>
            <p>Patient: <strong id="q-patient-id" style="font-size:1.2rem; color:var(--nhs-blue);">...</strong></p>
            
            <div id="clinical-instruction-box" class="clinical-note" style="display:none;"></div>

            <div class="instruction-card" id="question-text">
                Question goes here?
            </div>

            <!-- YES/NO BUTTONS -->
            <div style="margin-top: auto;">
                <button class="btn btn-yes" onclick="handleAnswer(true)">YES</button>
                <button class="btn btn-no" onclick="handleAnswer(false)">NO</button>
                <button class="btn btn-secondary" style="margin-top:1rem; padding: 0.8rem;" onclick="resetToHome()">Cancel Case</button>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen" class="screen">
            <h2>Triage Result</h2>
            <p style="text-align:center;">ID: <strong id="r-patient-id" style="font-size:1.2rem;"></strong></p>
            
            <div id="result-tag" class="triage-tag">
                <span id="tag-text">P1</span>
                <div id="hr-badge" class="hr-badge" style="display:none;">HIGH RISK</div>
            </div>
            
            <div id="action-box" class="clinical-note" style="font-size: 1.1rem; font-weight: bold; text-align: center; border-color: var(--nhs-red); color: var(--nhs-red);">
                <!-- Actions -->
            </div>
            
            <div style="text-align:center; font-size:0.8rem; margin-bottom:1rem;">
                GPS: <span id="location-status-text">...</span>
            </div>

            <button class="btn btn-secondary" onclick="addDetails()">+ Add Clinical Details / Notes</button>

            <div style="margin-top:auto;">
                <button class="btn btn-primary" onclick="nextPatient()">NEXT PATIENT &rarr;</button>
                <button class="btn btn-secondary" onclick="showLog()">View Log</button>
            </div>
        </div>

        <!-- CLINICAL DETAILS SCREEN (EDITABLE) -->
        <div id="details-screen" class="screen">
            <h2 id="details-header">Clinical Details</h2>
            <p>For: <strong id="d-patient-id"></strong></p>

            <div class="input-group">
                <label>Category Override</label>
                <select id="p-cat-override">
                    <option value="P1">P1 - Immediate</option>
                    <option value="P2">P2 - Urgent</option>
                    <option value="P3">P3 - Delayed</option>
                    <option value="DEAD">DEAD - Expectant</option>
                </select>
            </div>

            <div class="input-group">
                <label>Demographics</label>
                <input type="text" id="p-demos" placeholder="Age / Gender (e.g. 35M)">
            </div>

            <div class="input-group">
                <label>Allergies</label>
                <input type="text" id="p-allergies" placeholder="e.g. Penicillin">
            </div>

            <div class="input-group">
                <label>Clinical Notes</label>
                <textarea id="p-notes" rows="4" placeholder="Injuries, Time of Tourniquet, etc."></textarea>
            </div>

            <div id="risk-container" style="display:none; margin-bottom: 1rem;">
                 <label style="display:flex; align-items:center; gap:10px; font-weight:bold; color:var(--nhs-red); padding:10px; border:1px solid var(--nhs-red); border-radius:4px;">
                    <input type="checkbox" id="risk-check" style="width:24px; height:24px;">
                    HIGH RISK OF DETERIORATION
                 </label>
            </div>

            <button class="btn btn-primary" onclick="saveDetails()">Save Changes</button>
            <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
        </div>

        <!-- METHANE SCREEN -->
        <div id="methane-screen" class="screen">
            <h2>METHANE Report</h2>
            <div class="input-group">
                <label>M - Major Incident Declared?</label>
                <select id="m-decl"><option>Standby</option><option>DECLARED</option><option>Cancelled</option></select>
            </div>
            <div class="input-group">
                <label>E - Exact Location</label>
                <input type="text" id="m-loc">
            </div>
            <div class="input-group">
                <label>T - Type of Incident</label>
                <input type="text" id="m-type">
            </div>
            <div class="input-group">
                <label>H - Hazards</label>
                <input type="text" id="m-haz">
            </div>
            <div class="input-group">
                <label>A - Access</label>
                <input type="text" id="m-acc">
            </div>
            <div class="input-group">
                <label>N - Number of Casualties</label>
                <input type="text" id="m-num" type="number" pattern="[0-9]*">
            </div>
            <div class="input-group">
                <label>E - Emergency Services Required</label>
                <textarea id="m-svc" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveMethane()">Save Report</button>
            <button class="btn btn-secondary" onclick="resetToHome()">Cancel</button>
        </div>

        <!-- LOG SCREEN -->
        <div id="log-screen" class="screen">
            <h2>Live Dashboard</h2>
            
            <div class="dashboard">
                <div class="dash-card dash-p1"><span class="dash-num" id="count-p1">0</span><span class="dash-label">P1</span></div>
                <div class="dash-card dash-p2"><span class="dash-num" id="count-p2">0</span><span class="dash-label">P2</span></div>
                <div class="dash-card dash-p3"><span class="dash-num" id="count-p3">0</span><span class="dash-label">P3</span></div>
                <div class="dash-card dash-dead"><span class="dash-num" id="count-dead">0</span><span class="dash-label">DEAD</span></div>
            </div>

            <h3>Patient Log <small style="font-weight:normal; font-size:0.7rem;">(Tap row to edit)</small></h3>
            <div class="log-actions" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;">
                <button class="btn btn-primary" style="flex:1; padding:0.5rem; font-size:0.9rem;" onclick="copyLog()">Copy All (w/ METHANE)</button>
                <button class="btn btn-primary" style="flex:1; padding:0.5rem; font-size:0.9rem;" onclick="downloadCSV()">CSV (w/ METHANE)</button>
            </div>
            
            <div class="log-container">
                <table id="log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>ID</th>
                            <th>Cat</th>
                            <th>Loc</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>

            <div style="margin-top: 1rem; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="resetToHome()">Back</button>
                <button class="btn btn-danger" onclick="clearAllData()">Reset Incident</button>
            </div>
        </div>
    </main>
</div>

<script>
    // --- STATE ---
    let userRole = null; 
    let callSign = "";
    let currentTool = null;
    let patientCounter = 1;
    let incidentLog = [];
    let currentPatientId = ""; 
    let currentLogIndex = -1; 
    
    // GPS State
    let currentPosition = null; 
    let gpsAccuracy = null;
    let watchId = null;

    // --- INITIALIZATION ---
    window.onload = function() {
        initGPS();
        loadLocalData(); 
        updateDashboard();
        if (localStorage.getItem('mit_night_mode') === 'true') {
            document.body.classList.add('night-mode');
        }
    };

    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function initGPS() {
        if ("geolocation" in navigator) {
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    gpsAccuracy = Math.round(position.coords.accuracy);
                    currentPosition = {
                        lat: position.coords.latitude.toFixed(6),
                        lng: position.coords.longitude.toFixed(6),
                        acc: gpsAccuracy
                    };
                    updateGPSIndicator(true);
                },
                (error) => { updateGPSIndicator(false); },
                { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 }
            );
        } else { document.getElementById('gps-indicator').innerText = "GPS Error"; }
    }

    function updateGPSIndicator(isActive) {
        const el = document.getElementById('gps-indicator');
        if (isActive) {
            el.innerText = `GPS: ±${gpsAccuracy}m`;
            el.className = "gps-status gps-active";
        } else {
            el.innerText = "GPS: No Signal";
            el.className = "gps-status gps-inactive";
        }
    }

    function toggleNightMode() {
        document.body.classList.toggle('night-mode');
        localStorage.setItem('mit_night_mode', document.body.classList.contains('night-mode'));
    }

    function toggleBlackout() {
        const curtain = document.getElementById('blackout-curtain');
        if(curtain.classList.contains('active')) {
             curtain.classList.remove('active');
        } else {
            curtain.classList.add('active');
        }
    }

    // --- PERSISTENCE ---
    function saveLocalData() {
        localStorage.setItem('mit_triage_log', JSON.stringify(incidentLog));
        localStorage.setItem('mit_patient_counter', patientCounter.toString());
        localStorage.setItem('mit_callsign', callSign);
        if (userRole) localStorage.setItem('mit_user_role', userRole);
        
        const methaneData = {
            m: document.getElementById('m-decl').value,
            e: document.getElementById('m-loc').value,
            t: document.getElementById('m-type').value,
            h: document.getElementById('m-haz').value,
            a: document.getElementById('m-acc').value,
            n: document.getElementById('m-num').value,
            e_svc: document.getElementById('m-svc').value
        };
        localStorage.setItem('mit_methane', JSON.stringify(methaneData));
    }

    function loadLocalData() {
        const savedLog = localStorage.getItem('mit_triage_log');
        const savedCount = localStorage.getItem('mit_patient_counter');
        const savedRole = localStorage.getItem('mit_user_role');
        const savedCallSign = localStorage.getItem('mit_callsign');
        const savedMethane = localStorage.getItem('mit_methane');

        if (savedLog) incidentLog = JSON.parse(savedLog);
        if (savedCount) patientCounter = parseInt(savedCount);
        if (savedCallSign) {
            callSign = savedCallSign;
            document.getElementById('intro-callsign').value = callSign;
            document.getElementById('header-callsign').innerText = callSign ? `Device: ${callSign}` : "Device: -";
        }
        
        if (savedMethane) {
            const m = JSON.parse(savedMethane);
            document.getElementById('m-decl').value = m.m;
            document.getElementById('m-loc').value = m.e;
            document.getElementById('m-type').value = m.t;
            document.getElementById('m-haz').value = m.h;
            document.getElementById('m-acc').value = m.a;
            document.getElementById('m-num').value = m.n;
            document.getElementById('m-svc').value = m.e_svc;
        }

        if (savedRole) setUserRole(savedRole);
    }

    function clearAllData() {
        const confirmCode = prompt("SECURITY CHECK:\nTo wipe all data, type 'DELETE' below:");
        if(confirmCode === "DELETE") {
            localStorage.clear();
            location.reload(); 
        }
    }
    
    // --- ROLE & SETUP ---
    function setUserRole(role) {
        userRole = role;
        const inputCS = document.getElementById('intro-callsign').value.trim().toUpperCase();
        if(inputCS) callSign = inputCS;
        document.getElementById('header-callsign').innerText = callSign ? `Device: ${callSign}` : "Device: -";
        saveLocalData();
        
        document.getElementById('btn-mitt').style.display = (role === 'NON_HCP') ? 'none' : 'block';
        document.getElementById('risk-container').style.display = (role === 'HCP') ? 'block' : 'none';
        showScreen('home-screen');
    }

    function resetApp() {
        if(confirm("Return to setup? Log data is SAFE.")) showScreen('intro-screen');
    }

    // --- TRIAGE LOGIC ---
    const tstFlow = [
        { id: 'walking', question: "Is the casualty walking?", instruction: "Instruct casualties to move to a safe area.", yes: { type: 'result', category: 'P3', action: "Survivor Reception Centre" }, no: { type: 'next', step: 'bleeding' } },
        { id: 'bleeding', question: "Is there severe bleeding?", instruction: "Look for catastrophic haemorrhage.", yes: { type: 'result', category: 'P1', action: "Control Bleeding Immediately" }, no: { type: 'next', step: 'talking' } },
        { id: 'talking', question: "Is the casualty talking?", instruction: "Can they obey simple commands?", yes: { type: 'next', step: 'penetrating' }, no: { type: 'next', step: 'breathing' } },
        { id: 'penetrating', question: "Is there a penetrating injury?", instruction: "Check front and back (Chest/Abdomen).", yes: { type: 'result', category: 'P1', action: "Immediate Priority" }, no: { type: 'result', category: 'P2', action: "Urgent Priority" } },
        { id: 'breathing', question: "Is the casualty breathing?", instruction: "Open airway. Check for signs of life.", yes: { type: 'result', category: 'P1', action: "Recovery Position" }, no: { type: 'result', category: 'DEAD', action: "Dead (unless resources allow CPR)" } }
    ];

    const mittFlow = [
        { id: 'cat_bleed', question: "Is there catastrophic bleeding?", instruction: "Assess for life-threatening haemorrhage.", yes: { type: 'result', category: 'P1', action: "Control Bleeding Immediately" }, no: { type: 'next', step: 'walking' } },
        { id: 'walking', question: "Is the casualty walking?", instruction: "", yes: { type: 'result', category: 'P3', action: "Minor Injuries Unit" }, no: { type: 'next', step: 'breathing' } },
        { id: 'breathing', question: "Is the casualty breathing?", instruction: "Open Airway. (Paeds: 5 rescue breaths if drowning/smoke).", yes: { type: 'next', step: 'voice' }, no: { type: 'result', category: 'DEAD', action: "Confirm Dead" } },
        { id: 'voice', question: "Does casualty respond to voice?", instruction: "AVPU Scale: Alert or Voice?", yes: { type: 'next', step: 'age' }, no: { type: 'result', category: 'P1', action: "Unconscious - P1" } },
        { id: 'age', question: "Is the casualty aged over 2 years?", instruction: "Estimate age if unknown.", yes: { type: 'next', step: 'rr' }, no: { type: 'result', category: 'P1', action: "Paediatric Priority (Under 2)" } },
        { id: 'rr', question: "Is Respiratory Rate 12 - 23?", instruction: "Count breaths per minute.", yes: { type: 'next', step: 'hr' }, no: { type: 'result', category: 'P1', action: "Abnormal Respiration - P1" } },
        { id: 'hr', question: "Is Heart Rate < 100?", instruction: "Check radial pulse or capillary refill.", yes: { type: 'result', category: 'P2', action: "Stable Physiology - P2" }, no: { type: 'result', category: 'P1', action: "Tachycardic (HR ≥ 100) - P1" } }
    ];

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector('main').scrollTop = 0;
    }

    function initiateTriage(tool) {
        currentTool = tool;
        const prefix = callSign ? `${callSign}-${tool}` : tool;
        currentPatientId = `${prefix}-${pad(patientCounter, 3)}`;
        document.getElementById('q-patient-id').innerText = currentPatientId;
        
        // Mode Badge
        const badge = document.getElementById('mode-indicator');
        badge.innerText = tool;
        badge.style.display = 'inline-block';
        badge.style.backgroundColor = tool === 'MITT' ? '#E87722' : '#007F3B'; 

        if (currentTool === 'TST') loadStep(tstFlow[0]);
        else loadStep(mittFlow[0]);
        showScreen('question-screen');
    }

    function loadStep(stepObj) {
        document.getElementById('question-screen').dataset.stepId = stepObj.id;
        document.getElementById('question-text').innerText = stepObj.question;
        const instructBox = document.getElementById('clinical-instruction-box');
        if (stepObj.instruction) {
            instructBox.style.display = 'block';
            instructBox.innerText = stepObj.instruction;
        } else { instructBox.style.display = 'none'; }
    }

    function handleAnswer(answer) {
        const stepId = document.getElementById('question-screen').dataset.stepId;
        const flow = currentTool === 'TST' ? tstFlow : mittFlow;
        const currentStepObj = flow.find(s => s.id === stepId);
        const outcome = answer ? currentStepObj.yes : currentStepObj.no;

        if (outcome.type === 'next') {
            loadStep(flow.find(s => s.id === outcome.step));
        } else if (outcome.type === 'result') {
            logResult(outcome.category, outcome.action);
        }
    }

    function logResult(category, action) {
        const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const entry = {
            id: currentPatientId, time: time, tool: currentTool, category: category, action: action,
            location: currentPosition, demos: "", allergies: "", notes: "", highRisk: false
        };

        incidentLog.push(entry);
        currentLogIndex = incidentLog.length - 1; 
        saveLocalData();
        updateDashboard();

        document.getElementById('r-patient-id').innerText = currentPatientId;
        const tag = document.getElementById('result-tag');
        document.getElementById('tag-text').innerText = category;
        
        tag.className = 'triage-tag'; 
        if (category === 'P1') tag.classList.add('p1');
        else if (category === 'P2') tag.classList.add('p2');
        else if (category === 'P3') tag.classList.add('p3');
        else tag.classList.add('dead');

        document.getElementById('hr-badge').style.display = 'none';
        document.getElementById('action-box').innerText = action;
        
        const locText = document.getElementById('location-status-text');
        locText.innerHTML = currentPosition ? `${currentPosition.lat}, ${currentPosition.lng}` : "No GPS";
        locText.style.color = currentPosition ? "var(--nhs-green)" : "var(--nhs-red)";

        showScreen('result-screen');
    }

    // --- DETAILS & EDITING ---
    function addDetails() {
        document.getElementById('d-patient-id').innerText = currentPatientId;
        // Reset or Fill
        const entry = incidentLog[currentLogIndex];
        document.getElementById('p-cat-override').value = entry.category;
        document.getElementById('p-demos').value = entry.demos;
        document.getElementById('p-allergies').value = entry.allergies;
        document.getElementById('p-notes').value = entry.notes;
        document.getElementById('risk-check').checked = entry.highRisk;
        
        showScreen('details-screen');
    }

    function saveDetails() {
        if(currentLogIndex > -1) {
            const entry = incidentLog[currentLogIndex];
            entry.category = document.getElementById('p-cat-override').value; // Allow Override
            entry.demos = document.getElementById('p-demos').value;
            entry.allergies = document.getElementById('p-allergies').value;
            entry.notes = document.getElementById('p-notes').value;
            entry.highRisk = document.getElementById('risk-check').checked;
            
            saveLocalData();
            updateDashboard();
            showToast("Saved");
        }
        // If we came from the Log view, go back to Log. If from Result, go back to Result.
        // Simple logic: if editing old entry, go to Log.
        if (currentPatientId !== incidentLog[currentLogIndex].id) {
             showScreen('log-screen');
        } else {
             // We are on the active patient
             const tag = document.getElementById('result-tag');
             document.getElementById('tag-text').innerText = incidentLog[currentLogIndex].category;
             // Update colors based on override
             tag.className = 'triage-tag'; 
             if (entry.category === 'P1') tag.classList.add('p1');
             else if (entry.category === 'P2') tag.classList.add('p2');
             else if (entry.category === 'P3') tag.classList.add('p3');
             else tag.classList.add('dead');
             
             document.getElementById('hr-badge').style.display = entry.highRisk ? 'block' : 'none';
             showScreen('result-screen');
        }
    }
    
    function cancelEdit() {
        if (currentPatientId !== incidentLog[currentLogIndex].id) showScreen('log-screen');
        else showScreen('result-screen');
    }

    // --- LOGIC FOR EDITING PAST ENTRIES ---
    function editEntry(index) {
        currentLogIndex = index;
        const entry = incidentLog[index];
        
        document.getElementById('d-patient-id').innerText = entry.id;
        document.getElementById('p-cat-override').value = entry.category;
        document.getElementById('p-demos').value = entry.demos;
        document.getElementById('p-allergies').value = entry.allergies;
        document.getElementById('p-notes').value = entry.notes;
        document.getElementById('risk-check').checked = entry.highRisk;
        
        showScreen('details-screen');
    }

    function showMethane() { showScreen('methane-screen'); }
    function saveMethane() { saveLocalData(); showToast("Report Saved"); showScreen('home-screen'); }

    function nextPatient() {
        patientCounter++;
        saveLocalData();
        initiateTriage(currentTool); 
    }

    function resetToHome() { showScreen('home-screen'); }

    function updateDashboard() {
        let p1=0, p2=0, p3=0, dead=0;
        incidentLog.forEach(e => {
            if(e.category === 'P1') p1++;
            else if(e.category === 'P2') p2++;
            else if(e.category === 'P3') p3++;
            else dead++;
        });
        document.getElementById('count-p1').innerText = p1;
        document.getElementById('count-p2').innerText = p2;
        document.getElementById('count-p3').innerText = p3;
        document.getElementById('count-dead').innerText = dead;
    }

    function showLog() {
        const tbody = document.getElementById('log-body');
        tbody.innerHTML = '';
        
        // Show newest first
        const reversedLog = [...incidentLog].map((e, i) => ({...e, originalIndex: i})).reverse();
        
        reversedLog.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "clickable-row";
            tr.onclick = function() { editEntry(row.originalIndex); }; // Hook up edit
            
            let catStyle = '';
            if(row.category === 'P1') catStyle = 'background-color:var(--nhs-red); color:white; font-weight:bold;';
            if(row.category === 'P2') catStyle = 'background-color:var(--nhs-yellow);';
            if(row.category === 'P3') catStyle = 'background-color:var(--nhs-green); color:white;';
            if(row.category === 'DEAD') catStyle = 'background-color:#333; color:white;';

            let locText = row.location ? `${row.location.lat}, ${row.location.lng}` : "-";
            let details = "";
            if(row.demos) details += `[${row.demos}] `;
            if(row.allergies) details += `Allergies: ${row.allergies}. `;
            if(row.notes) details += `${row.notes}`;
            if(row.highRisk) details = `<span style="color:red; font-weight:bold;">[HIGH RISK]</span> ` + details;

            tr.innerHTML = `
                <td>${row.time}</td>
                <td><strong>${row.id}</strong></td>
                <td style="${catStyle}">${row.category}</td>
                <td style="font-size:0.75rem;">${locText}</td>
                <td style="font-size:0.8rem;">${details}</td>
            `;
            tbody.appendChild(tr);
        });
        showScreen('log-screen');
    }

    function getMethaneString() {
         const m = JSON.parse(localStorage.getItem('mit_methane') || "{}");
         if(!m.m) return "";
         return `METHANE REPORT\n----------------\nM: ${m.m}\nE: ${m.e}\nT: ${m.t}\nH: ${m.h}\nA: ${m.a}\nN: ${m.n}\nE: ${m.e_svc}\n----------------\n\n`;
    }

    function copyLog() {
        let text = getMethaneString() + "PATIENT LOG\n";
        incidentLog.forEach(r => {
            text += `${r.time} | ${r.id} | ${r.category} | ${r.action} | ${r.demos} ${r.notes}\n`;
        });
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => showToast("Copied to Clipboard"))
            .catch(() => fallbackCopy(text));
        } else { fallbackCopy(text); }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try { document.execCommand('copy'); showToast("Copied"); } catch (err) {}
        document.body.removeChild(textArea);
    }

    function downloadCSV() {
        const m = JSON.parse(localStorage.getItem('mit_methane') || "{}");
        let csv = "";
        
        // Add METHANE as headers/comments
        if(m.m) {
            csv += `METHANE REPORT\n`;
            csv += `M,${m.m}\nE,${m.e}\nT,${m.t}\nH,${m.h}\nA,${m.a}\nN,${m.n}\nE,${m.e_svc}\n\n`;
        }

        csv += "Time,ID,Category,Action,Lat,Lng,Age/Gender,Allergies,Notes,HighRisk\n";
        incidentLog.forEach(r => {
            const lat = r.location ? r.location.lat : "";
            const lng = r.location ? r.location.lng : "";
            const noteSafe = r.notes.replace(/,/g, " ").replace(/\n/g, " ");
            csv += `${r.time},${r.id},${r.category},${r.action},${lat},${lng},${r.demos},${r.allergies},${noteSafe},${r.highRisk}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `incident_log_${new Date().getTime()}.csv`;
        a.click();
        showToast("CSV Downloaded");
    }

    function pad(num, size) {
        num = num.toString();
        while (num.length < size) num = "0" + num;
        return num;
    }
</script>
</body>
</html>
